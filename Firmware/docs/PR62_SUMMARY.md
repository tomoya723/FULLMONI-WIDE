# PR #62 要約 - emWin画像リソースアドレスの可変性とランタイム解決

## プルリクエスト概要

**タイトル**: Document emWin image resource address variability and runtime resolution

**URL**: https://github.com/tomoya723/FULLMONI-WIDE/pull/62

## 背景となった質問

> emWinの画像リソースをコンパイル後実装される物理アドレスは、コンパイル事に変動する可能性はあるか？もしくは固定アドレスか？

この質問に答えるため、技術的な調査を行い、ドキュメントを作成しました。

## 主な内容

### 1. 回答の結論

**アドレスはコンパイルごとに変動します。** emWinリソース（`GUI_CONST_STORAGE`）はリンカによって`.rodata`セクションに配置され、オブジェクトファイルの順序、コードサイズの変更、最適化設定などに基づいて自動的に配置されます。

### 2. 追加されたドキュメント

#### 新規作成: `Firmware/docs/EMWIN_RESOURCE_ADDRESS.md`

技術ドキュメントとして以下の内容を詳細に説明：

- **なぜアドレスが変動するか**  
  リンカの`.rodata`セクション内での自動配置動作について

- **現在の実装のアプローチ**  
  実行時アドレス解決を使用する方法とその適切性

- **代替案（固定配置）**  
  技術的には可能だが推奨しない理由を説明

- **コード参照と実例**  
  `startup_image_write.c`でのアドレス取得方法を具体的に示す

#### 更新: `Firmware/README.md`

「技術ドキュメント」セクションを追加し、新しいドキュメントと既存のガイドへのリンクを整理しました。

### 3. 現在の実装の評価

既存のコードは正しくアドレス変動に対応していることを確認：

```c
// startup_image_write.c
void startup_image_write_mode(void)
{
    uint32_t acmtc_addr = (uint32_t)acmtc;  // ランタイムでアドレス解決
    param_console_printf("Target address: 0x%08lX\r\n", acmtc_addr);
    // このダイナミックアドレスを使用してフラッシュ書き込み操作を実行
}
```

このアプローチは堅牢で推奨されます。リンカセクションやプラグマを使った固定アドレス配置は、このユースケースでは保守性を低下させるだけで意味のある利点を提供しません。

## 技術的な詳細まとめ

| 観点 | 詳細 |
|------|------|
| **アドレスは固定か？** | いいえ、コンパイルごとに変動 |
| **現在のアプローチ** | 実行時シンボルアドレス解決 |
| **推奨事項** | 現在の実装を維持すること |

## PR の影響

### 変更されたファイル
- `Firmware/docs/EMWIN_RESOURCE_ADDRESS.md` (新規作成)
- `Firmware/README.md` (技術ドキュメントセクション追加)

### コード変更
なし - ドキュメントのみの追加

### 追加行数
- 追加: 212行
- 削除: 0行
- 変更ファイル数: 2

## このPRの意義

1. **技術的な疑問に対する明確な回答**  
   開発者がemWinリソースのアドレス配置について持つ疑問に対し、詳細な技術解説を提供

2. **実装の正当性の確認**  
   現在のコードが適切な方法（実行時アドレス解決）を使用していることを文書化

3. **将来の保守性向上**  
   固定アドレス配置などの不適切なアプローチを避けるためのガイダンスを提供

4. **知識の共有**  
   リンカの動作、メモリ配置、実装の選択肢についての知識をチームで共有

## 関連ドキュメント

- [emWin画像リソースの物理アドレスについて](./EMWIN_RESOURCE_ADDRESS.md) - 本体ドキュメント
- [起動画面書き込み機能](./STARTUP_IMAGE_WRITE.md) - 関連する実装ガイド
- [Firmware README](../README.md) - ファームウェア全般の説明
