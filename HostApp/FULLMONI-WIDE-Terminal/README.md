# FULLMONI-WIDE Terminal

FULLMONI-WIDEファームウェアとUSB CDC通信するためのWindowsホストアプリケーションです。

## 機能

### ターミナル機能
- **シリアル通信**: COMポートを選択して115200bps（8N1）で接続
- **ターミナル表示**: ファームウェアからの応答をリアルタイム表示
- **コマンド入力**: テキストボックスからコマンドを送信
- **クイックコマンド**: よく使うコマンドをワンクリックで送信
- **コマンド履歴**: 上下矢印キーで過去のコマンドを呼び出し
- **COMポート更新**: 「更新」ボタンでポートリストを再読込

### パラメータ設定GUI
- **タイヤサイズ設定**: 幅/扁平率/リム径を入力
- **ギアプリセット**: 車種別プリセットから選択可能
- **ギア比設定**: 1〜6速およびファイナルギア
- **警告設定**: 水温低温/高温、燃料警告閾値
- **シフトインジケータ設定**: 5段階のシフトアップRPMを色分け表示で設定
- **入力バリデーション**: 保存前に全パラメータの妥当性をチェック
- **ワンクリック保存**: GUIで設定した値をまとめてファームウェアに書き込み

### ファームウェア更新機能
- **GUIから直接更新**: BINファイルを選択してワンクリックで更新
- **自動ブートローダー切替**: ファームウェアに`fwupdate`コマンドを自動送信
- **高速転送**: ストリーミングモードで約268 KB/s（1.27MB → 約4.6秒）
- **進捗表示**: 全フェーズ（切替 → 消去 → 転送 → 検証）の進捗をリアルタイム表示
- **自動再接続**: 更新完了後、自動でCOMポートに再接続

## 対応コマンド（ファームウェア側）

| コマンド | 説明 |
|---------|------|
| `help` | コマンド一覧表示 |
| `version` | ファームウェアバージョン表示 |
| `list` | 現在のパラメータ一覧 |
| `set <id> <value>` | パラメータ設定 |
| `save` | EEPROMに保存 |
| `load` | EEPROMから読込 |
| `default` | デフォルト値にリセット |
| `rtc` | RTC時刻表示 |
| `rtc YY MM DD hh mm ss` | RTC時刻設定 |
| `odo` | オドメーター表示 |
| `odo_init <km>` | オドメーター初期化 |
| `trip` | トリップメーター表示 |
| `trip_reset` | トリップリセット |
| `fwupdate` | ファームウェアアップデートモード |
| `exit` | パラメータモード終了 |

## パラメータID

| カテゴリ | パラメータID | 説明 | 範囲 |
|---------|-------------|------|------|
| タイヤサイズ | `tyre_width` | タイヤ幅 (mm) | 1～500（整数） |
| | `tyre_aspect` | 扁平率 (%) | 1～500（整数） |
| | `tyre_rim` | リム径 (インチ) | 1～500（整数） |
| ギア比 | `gear1` ~ `gear6` | 各ギア比 | 正の小数、降順 |
| | `final` | ファイナルギア比 | 正の小数 |
| 警告設定 | `water_low` | 水温低温警告 (℃) | -40～200（整数） |
| | `water_high` | 水温高温警告 (℃) | -40～200（整数） |
| | `fuel_warn` | 燃料警告閾値 | 0～1000（整数） |
| シフトインジケータ | `shift_rpm1` | 青2灯 (rpm) | 1～15000（整数）昇順 |
| | `shift_rpm2` | 青4灯 (rpm) | 1～15000（整数）昇順 |
| | `shift_rpm3` | 緑6灯 (rpm) | 1～15000（整数）昇順 |
| | `shift_rpm4` | 赤8灯 (rpm) | 1～15000（整数）昇順 |
| | `shift_rpm5` | 白点滅 (rpm) | 1～15000（整数）昇順 |

## 入力バリデーション

保存時に以下のバリデーションが実行されます：

| 項目 | ルール |
|------|--------|
| タイヤサイズ | 1～500の正の整数 |
| 水温警告 | -40～200の整数、低温 < 高温 |
| 燃料警告 | 0～1000の整数 |
| ギア比 | 正の小数、1速 > 2速 > 3速 > 4速 > 5速 > 6速 |
| シフトRPM | 1～15000の正の整数、青2灯 < 青4灯 < 緑6灯 < 赤8灯 < 白点滅 |

バリデーションエラーがある場合、ダイアログで詳細が表示されます。

## ビルド方法

### 必要環境
- .NET 8.0 SDK
- Visual Studio 2022 または VS Code

### ビルドコマンド
```bash
cd HostApp/FULLMONI-WIDE-Terminal
dotnet build
```

### 実行
```bash
dotnet run
```

### 発行（スタンドアロン実行ファイル）
```bash
dotnet publish -c Release -r win-x64 --self-contained
```

## 使用方法

### 基本操作
1. アプリを起動
2. COMポートを選択（ファームウェアが接続されているポート）
3. ボーレートは115200（デフォルト）
4. 「Connect」ボタンをクリック
5. ファームウェア側で任意のキーを押してパラメータモードに入る
6. コマンドを入力またはクイックコマンドをクリック

### パラメータ設定GUI
1. 接続後、「Load」ボタンで現在のパラメータを読み込み
2. 右側パネルで各パラメータを編集
3. ギアプリセットから車種を選択すると自動入力
4. 「Save」ボタンでファームウェアに書き込み
5. バリデーションエラーがあれば修正して再保存

## 技術仕様

- **フレームワーク**: .NET 8.0 WPF
- **アーキテクチャ**: MVVM (CommunityToolkit.Mvvm)
- **シリアル通信**: System.IO.Ports
- **通信設定**: 115200bps, 8N1, XON/XOFFフロー制御

## ライセンス

FULLMONI-WIDE Projectの一部として提供されます。
