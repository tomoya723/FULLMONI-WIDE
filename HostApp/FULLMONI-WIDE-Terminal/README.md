# FULLMONI-WIDE Terminal

FULLMONI-WIDEファームウェアとUSB CDC通信するためのWindowsホストアプリケーションです。

## 機能

### ターミナル機能
- **シリアル通信**: COMポートを選択して115200bps（8N1）で接続
- **ターミナル表示**: ファームウェアからの応答をリアルタイム表示
- **コマンド入力**: テキストボックスからコマンドを送信
- **クイックコマンド**: よく使うコマンドをワンクリックで送信
- **コマンド履歴**: 上下矢印キーで過去のコマンドを呼び出し
- **COMポート更新**: 「更新」ボタンでポートリストを再読込

### パラメータ設定GUI
- **タイヤサイズ設定**: 幅/扁平率/リム径を入力
- **ギアプリセット**: 車種別プリセットから選択可能
- **ギア比設定**: 1〜6速およびファイナルギア
- **警告設定**: 水温低温/高温、燃料警告閾値
- **シフトインジケータ設定**: 5段階のシフトアップRPMを色分け表示で設定
- **入力バリデーション**: 保存前に全パラメータの妥当性をチェック
- **ワンクリック保存**: GUIで設定した値をまとめてファームウェアに書き込み

### ファームウェア更新機能
- **GUIから直接更新**: BINファイルを選択してワンクリックで更新
- **自動ブートローダー切替**: ファームウェアに`fwupdate`コマンドを自動送信
- **高速転送**: ストリーミングモードで約268 KB/s（1.27MB → 約4.6秒）
- **進捗表示**: 全フェーズ（切替 → 消去 → 転送 → 検証）の進捗をリアルタイム表示
- **自動再接続**: 更新完了後、自動でCOMポートに再接続
- **Bootloaderモード検出**: ファームウェアが壊れている場合も直接更新可能

## 使用方法

### アプリケーションの起動

1. `FULLMONI-WIDE-Terminal.exe` を起動
2. ダークモード/ライトモードは右上のトグルで切り替え可能

### 接続方法

#### 通常接続（Firmwareが正常動作時）

1. **COMポート選択**: ドロップダウンからFULLMONI-WIDEが接続されているCOMポートを選択
   - ポートが表示されない場合は「更新」ボタンをクリック
2. **接続**: 「接続」ボタンをクリック
3. **自動認識**: アプリがFirmwareモードを検出し、パラメータを自動読込

#### Bootloaderモード接続（Firmwareが壊れている場合）

Firmwareが破損/消去されている場合、デバイスは自動的にBootloaderモードで起動します。

1. **COMポート選択**: Bootloaderが接続されているCOMポートを選択
2. **接続**: 「接続」ボタンをクリック
3. **自動検出**: アプリがBootloaderモードを検出
   - ステータスバーに「⚠️ Bootloaderモードで接続 - ファームウェア更新タブを使用してください」と表示
   - 「ステータス」「設定項目」タブが無効化（グレーアウト）
   - 「ファームウェア更新」タブのみ操作可能
4. **ファームウェア更新**: BINファイルを選択して更新を実行

### ステータスタブ

接続中のデバイスの状態を表示・操作します。

| 項目 | 説明 | 操作 |
|------|------|------|
| ODO | 総走行距離 (km) | 表示のみ |
| TRIP | トリップメーター (km) | 「RESET」ボタンでリセット |
| 日時 | デバイスのRTC時刻 | 「PC時刻と同期」ボタンで同期 |

- **再読込ボタン**: パラメータを再取得

### 設定項目タブ

デバイスの各種パラメータを設定します。

#### タイヤサイズ
| 項目 | 説明 | 入力例 |
|------|------|--------|
| 幅 | タイヤ幅 (mm) | 195 |
| 扁平率 | タイヤ扁平率 (%) | 55 |
| 径 | ホイール径 (インチ) | 16 |

#### ギア比設定
1. **プリセット選択**: ドロップダウンから車種を選択すると自動入力
2. **手動入力**: 各ギアのギア比を直接入力
   - 1速から6速まで降順（1速 > 2速 > ...）である必要あり

#### 警告設定
| 項目 | 説明 | 範囲 |
|------|------|------|
| 水温低温警告 | 青色警告表示の閾値 (℃) | -40～200 |
| 水温高温警告 | 赤色警告表示の閾値 (℃) | -40～200 |
| 燃料警告 | 燃料残量警告の閾値 | 0～1000 |

#### シフトインジケータ設定
シフトアップタイミングを5段階で設定。昇順である必要があります。

| 段階 | 表示色 | 説明 |
|------|--------|------|
| RPM1 | 青2灯 | 最初の点灯開始 |
| RPM2 | 青4灯 | 2段階目 |
| RPM3 | 緑6灯 | 3段階目 |
| RPM4 | 赤8灯 | 4段階目（注意） |
| RPM5 | 白点滅 | シフトアップ推奨 |

#### 保存操作
1. 各項目を設定
2. 「ファームウェアに保存」ボタンをクリック
3. バリデーションエラーがある場合はダイアログで表示
4. 保存成功後、ステータスバーに完了メッセージ

### ファームウェア更新タブ

#### 通常のファームウェア更新（Firmwareモード）

1. **BINファイル選択**: 「参照...」ボタンでファームウェアBINファイルを選択
2. **現在のバージョン確認**: 画面上部に現在のファームウェアバージョンが表示
3. **更新開始**: 「ファームウェア更新開始」ボタンをクリック
4. **確認ダイアログ**: 「はい」をクリックして更新開始
5. **更新プロセス**:
   - Bootloaderモードに切り替え
   - フラッシュ消去（約10秒）
   - ファームウェア転送（約5秒、268KB/s）
   - 検証
   - デバイス再起動
6. **自動再接続**: 更新完了後、自動でCOMポートに再接続

#### Bootloaderモードからの復旧更新

ファームウェアが壊れている場合（電源投入時にBootloaderメニューが表示される状態）：

1. **接続**: Bootloaderモードで接続（自動検出）
2. **BINファイル選択**: 「参照...」ボタンでファームウェアBINファイルを選択
3. **更新開始**: 「ファームウェア更新開始」ボタンをクリック
   - Bootloaderモードでは切り替えステップがスキップされ、直接転送開始
4. **更新完了**: Firmwareモードとして再接続、全タブが有効化

#### 転送プロトコル

| フェーズ | 説明 | 所要時間 |
|----------|------|----------|
| 切り替え | fwupdateコマンド送信 | 1秒 |
| 消去 | 3.875MBフラッシュ消去 | 約10秒 |
| 転送 | ストリーミングモード | 約5秒 |
| 検証 | ヘッダ・CRC確認 | 1秒 |
| 再起動 | 自動リセット | 3秒待機 |

### Aboutタブ

アプリケーション情報を表示します。

- アプリケーションバージョン
- 著作権情報
- オープンソースライセンス

## 対応コマンド（ファームウェア側）

| コマンド | 説明 |
|---------|------|
| `help` | コマンド一覧表示 |
| `version` | ファームウェアバージョン表示 |
| `list` | 現在のパラメータ一覧 |
| `set <id> <value>` | パラメータ設定 |
| `save` | EEPROMに保存 |
| `load` | EEPROMから読込 |
| `default` | デフォルト値にリセット |
| `rtc` | RTC時刻表示 |
| `rtc YY MM DD hh mm ss` | RTC時刻設定 |
| `odo` | オドメーター表示 |
| `odo_init <km>` | オドメーター初期化 |
| `trip` | トリップメーター表示 |
| `trip_reset` | トリップリセット |
| `fwupdate` | ファームウェアアップデートモード |
| `exit` | パラメータモード終了 |

## パラメータID

| カテゴリ | パラメータID | 説明 | 範囲 |
|---------|-------------|------|------|
| タイヤサイズ | `tyre_width` | タイヤ幅 (mm) | 1～500（整数） |
| | `tyre_aspect` | 扁平率 (%) | 1～500（整数） |
| | `tyre_rim` | リム径 (インチ) | 1～500（整数） |
| ギア比 | `gear1` ~ `gear6` | 各ギア比 | 正の小数、降順 |
| | `final` | ファイナルギア比 | 正の小数 |
| 警告設定 | `water_low` | 水温低温警告 (℃) | -40～200（整数） |
| | `water_high` | 水温高温警告 (℃) | -40～200（整数） |
| | `fuel_warn` | 燃料警告閾値 | 0～1000（整数） |
| シフトインジケータ | `shift_rpm1` | 青2灯 (rpm) | 1～15000（整数）昇順 |
| | `shift_rpm2` | 青4灯 (rpm) | 1～15000（整数）昇順 |
| | `shift_rpm3` | 緑6灯 (rpm) | 1～15000（整数）昇順 |
| | `shift_rpm4` | 赤8灯 (rpm) | 1～15000（整数）昇順 |
| | `shift_rpm5` | 白点滅 (rpm) | 1～15000（整数）昇順 |

## 入力バリデーション

保存時に以下のバリデーションが実行されます：

| 項目 | ルール |
|------|--------|
| タイヤサイズ | 1～500の正の整数 |
| 水温警告 | -40～200の整数、低温 < 高温 |
| 燃料警告 | 0～1000の整数 |
| ギア比 | 正の小数、1速 > 2速 > 3速 > 4速 > 5速 > 6速 |
| シフトRPM | 1～15000の正の整数、青2灯 < 青4灯 < 緑6灯 < 赤8灯 < 白点滅 |

バリデーションエラーがある場合、ダイアログで詳細が表示されます。

## トラブルシューティング

### COMポートが表示されない
- USBケーブルが正しく接続されているか確認
- デバイスマネージャーでCOMポートが認識されているか確認
- 「更新」ボタンをクリックしてポートリストを再取得

### 接続できない
- 他のアプリケーション（TeraTermなど）がポートを使用していないか確認
- デバイスの電源が入っているか確認
- USBケーブルを抜き差しして再試行

### パラメータが読み込めない
- ファームウェアがパラメータコンソールモードに入っているか確認
- 接続後、数秒待ってから「再読込」ボタンをクリック

### ファームウェア更新が失敗する
- 更新中は絶対に電源を切らないこと
- BINファイルが正しいファームウェアか確認
- 失敗した場合、デバイスを再起動してBootloaderモードから復旧

### Bootloaderモードから復旧できない
1. デバイスの電源を入れ直す（Bootloaderが自動起動）
2. アプリでCOMポートに接続
3. Bootloaderモードが検出される
4. 正しいBINファイルを選択して更新実行

## ビルド方法

### 必要環境
- .NET 8.0 SDK
- Visual Studio 2022 または VS Code

### ビルドコマンド
```bash
cd HostApp/FULLMONI-WIDE-Terminal
dotnet build
```

### 実行
```bash
dotnet run
```

### 発行（スタンドアロン実行ファイル）
```bash
dotnet publish -c Release -r win-x64 --self-contained
```

出力先: `bin/Release/net8.0-windows/win-x64/publish/`

## 技術仕様

- **フレームワーク**: .NET 8.0 WPF
- **アーキテクチャ**: MVVM (CommunityToolkit.Mvvm)
- **シリアル通信**: System.IO.Ports
- **通信設定**: 115200bps, 8N1, XON/XOFFフロー制御
- **転送速度**: 約268 KB/s（ストリーミングモード）

## ライセンス

FULLMONI-WIDE Projectの一部として提供されます。
