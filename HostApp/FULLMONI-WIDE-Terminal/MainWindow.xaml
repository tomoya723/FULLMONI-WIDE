<Window x:Class="FullmoniTerminal.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:FullmoniTerminal"
        xmlns:vm="clr-namespace:FullmoniTerminal.ViewModels"
        xmlns:views="clr-namespace:FullmoniTerminal.Views"
        mc:Ignorable="d"
        Title="FULLMONI-WIDE Terminal"
        Height="640" Width="530"
        ResizeMode="CanMinimize"
        FontFamily="Meiryo UI"
        Background="{DynamicResource BackgroundGradient}"
        Icon="Assets/FMW.ico"
        Closing="Window_Closing">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
    </Window.Resources>

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 接続バー -->
        <Border Grid.Row="0" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="6" Margin="0,0,0,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <ComboBox Grid.Column="0" ItemsSource="{Binding AvailablePorts}"
                          SelectedItem="{Binding SelectedPort}"
                          Style="{DynamicResource ModernComboBox}"
                          Width="80" Height="24" FontSize="12" IsEnabled="{Binding IsNotConnected}"/>

                <!-- COMポート更新ボタン -->
                <Button Grid.Column="1" Content="更新" Width="40" Height="24" Margin="4,0,0,0" FontSize="11"
                        Command="{Binding RefreshPortsCommand}"
                        ToolTip="COMポート一覧を更新"
                        Style="{DynamicResource SecondaryButton}"
                        IsEnabled="{Binding IsNotConnected}"/>

                <Button Grid.Column="2" Content="{Binding ConnectionButtonText}" Width="60" Height="24" Margin="4,0,0,0" FontSize="12"
                        Command="{Binding ConnectCommand}"
                        Style="{DynamicResource PrimaryButton}"
                        IsEnabled="{Binding CanCloseWindow}"/>

                <!-- 接続状態インジケータ（中央） -->
                <StackPanel Grid.Column="3" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Ellipse Width="8" Height="8" Margin="0,0,4,0">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="#E74C3C"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                        <Setter Property="Fill" Value="{DynamicResource SuccessBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Text="{Binding StatusText}" FontSize="12" Foreground="{DynamicResource TextBrush}"/>
                    <TextBlock Text=" | " FontSize="12" Foreground="{DynamicResource TextMutedBrush}"
                               Visibility="{Binding IsConnected, Converter={StaticResource BoolToVisibility}}"/>
                    <TextBlock Text="{Binding FirmwareVersion, StringFormat=v{0}}" FontSize="12" Foreground="{DynamicResource TextMutedBrush}"
                               Visibility="{Binding IsConnected, Converter={StaticResource BoolToVisibility}}"/>
                </StackPanel>

                <!-- テーマ切り替え（右側） -->
                <StackPanel Grid.Column="4" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0,0,0">
                    <TextBlock Text="☀" FontSize="12" VerticalAlignment="Center" Margin="0,0,4,0" Foreground="{DynamicResource TextMutedBrush}"/>
                    <ToggleButton Style="{DynamicResource ThemeToggleButton}"
                                  IsChecked="{Binding IsDarkTheme}"/>
                    <TextBlock Text="🌙" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- タブコントロール -->
        <TabControl Grid.Row="1" Margin="0,0,0,6" SelectedIndex="5">
            <!-- タブ1: ステータス -->
            <TabItem Header="ステータス" IsEnabled="{Binding IsFirmwareMode}">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- ODO/TRIP/RTC -->
                    <Border Grid.Row="0" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="60"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="30"/>
                                <RowDefinition Height="30"/>
                                <RowDefinition Height="30"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="ODO" FontSize="12" FontWeight="Bold" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}" Margin="0,3,0,3"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding OdoValue, StringFormat={}{0} km}" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}" Margin="0,3,0,3"/>
                            <Border Grid.Row="0" Grid.Column="2" Width="90" Height="24"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="TRIP" FontSize="12" FontWeight="Bold" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}" Margin="0,3,0,3"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TripValue, StringFormat={}{0} km}" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}" Margin="0,3,0,3"/>
                            <Button Grid.Row="1" Grid.Column="2" Content="RESET" Width="90" Height="24" FontSize="12"
                                    Style="{DynamicResource OutlineButton}"
                                    Command="{Binding ResetTripCommand}"
                                    IsEnabled="{Binding IsOperationEnabled}"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="日時" FontSize="12" FontWeight="Bold" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}" Margin="0,3,0,3"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding RtcValue}" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}" Margin="0,3,0,3"/>
                            <Button Grid.Row="2" Grid.Column="2" Content="PC時刻と同期" Width="90" Height="24" FontSize="12"
                                    Style="{DynamicResource OutlineButton}"
                                    Command="{Binding SyncRtcCommand}"
                                    IsEnabled="{Binding IsOperationEnabled}"/>
                        </Grid>
                    </Border>

                    <!-- 再読込ボタン -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                        <Button Content="再読込" Width="80" Height="28" FontSize="12"
                                Style="{DynamicResource PrimaryButton}"
                                Command="{Binding LoadParametersCommand}"
                                IsEnabled="{Binding IsOperationEnabled}"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- タブ2: 設定項目 -->
            <TabItem Header="設定項目" IsEnabled="{Binding IsFirmwareMode}">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- 左カラム: タイヤ設定 -->
                            <StackPanel Grid.Column="0">
                            <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="8" Margin="0,0,0,6">
                                <StackPanel>
                                    <TextBlock Text="タイヤサイズ" FontWeight="Bold" FontSize="12" Margin="0,0,0,6" Foreground="{DynamicResource TextBrush}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="50"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="30"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="幅" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding TyreWidth}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <TextBlock Grid.Row="0" Grid.Column="2" Text="mm" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="扁平率" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding TyreAspect}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <TextBlock Grid.Row="1" Grid.Column="2" Text="%" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="径" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding WheelDia}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <TextBlock Grid.Row="2" Grid.Column="2" Text="inch" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="8">
                                <StackPanel>
                                    <TextBlock Text="ギア比" FontWeight="Bold" FontSize="12" Margin="0,0,0,6" Foreground="{DynamicResource TextBrush}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="50"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="プリセット" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <ComboBox Grid.Row="0" Grid.Column="1" ItemsSource="{Binding GearPresets}" SelectedItem="{Binding SelectedGearPreset}"
                                                  Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}">
                                            <ComboBox.ItemContainerStyle>
                                                <Style TargetType="ComboBoxItem" BasedOn="{StaticResource {x:Type ComboBoxItem}}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding}" Value="-- 選択 --">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.ItemContainerStyle>
                                        </ComboBox>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="1速" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding Gear1}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="2速" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding Gear2}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>

                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="3速" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding Gear3}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>

                                        <TextBlock Grid.Row="4" Grid.Column="0" Text="4速" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding Gear4}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>

                                        <TextBlock Grid.Row="5" Grid.Column="0" Text="5速" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="5" Grid.Column="1" Text="{Binding Gear5}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>

                                        <TextBlock Grid.Row="6" Grid.Column="0" Text="6速" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="6" Grid.Column="1" Text="{Binding Gear6}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>

                                        <TextBlock Grid.Row="7" Grid.Column="0" Text="ファイナル" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                        <TextBox Grid.Row="7" Grid.Column="1" Text="{Binding FinalGear}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- 右カラム: 警告設定 + シフトインジケータ -->
                        <StackPanel Grid.Column="2">
                        <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="8" Margin="0,0,0,6">
                            <StackPanel>
                                <TextBlock Text="警告設定" FontWeight="Bold" FontSize="12" Margin="0,0,0,6" Foreground="{DynamicResource TextBrush}"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="70"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="30"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="水温低温" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding WaterTempLow}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    <TextBlock Grid.Row="0" Grid.Column="2" Text="°C" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="水温高温" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding WaterTempHigh}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    <TextBlock Grid.Row="1" Grid.Column="2" Text="°C" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="燃料警告" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                    <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding FuelWarn}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    <TextBlock Grid.Row="2" Grid.Column="2" Text="L" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- シフトインジケータ設定 -->
                        <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="8">
                            <StackPanel>
                                <TextBlock Text="シフトインジケータ" FontWeight="Bold" FontSize="12" Margin="0,0,0,6" Foreground="{DynamicResource TextBrush}"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="70"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="30"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="青2灯" FontSize="12" VerticalAlignment="Center" Foreground="#3498DB"/>
                                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding ShiftRpm1}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    <TextBlock Grid.Row="0" Grid.Column="2" Text="rpm" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="青4灯" FontSize="12" VerticalAlignment="Center" Foreground="#3498DB"/>
                                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding ShiftRpm2}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    <TextBlock Grid.Row="1" Grid.Column="2" Text="rpm" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="緑6灯" FontSize="12" VerticalAlignment="Center" Foreground="#2ECC71"/>
                                    <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding ShiftRpm3}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    <TextBlock Grid.Row="2" Grid.Column="2" Text="rpm" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="赤8灯" FontSize="12" VerticalAlignment="Center" Foreground="#E74C3C"/>
                                    <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding ShiftRpm4}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    <TextBlock Grid.Row="3" Grid.Column="2" Text="rpm" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>

                                    <TextBlock Grid.Row="4" Grid.Column="0" Text="白点滅" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                    <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding ShiftRpm5}" Height="22" FontSize="12" Margin="0,2" IsEnabled="{Binding IsOperationEnabled}"/>
                                    <TextBlock Grid.Row="4" Grid.Column="2" Text="rpm" FontSize="12" VerticalAlignment="Center" Margin="4,0,0,0" Foreground="{DynamicResource TextMutedBrush}"/>
                                </Grid>
                            </StackPanel>
                        </Border>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>

                <!-- 下部ボタン -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,8,0,0">
                    <Button Content="再読込" Width="70" Height="26" FontSize="12" Margin="0,0,6,0"
                            Style="{DynamicResource PrimaryButton}"
                            Command="{Binding LoadParametersCommand}"
                            IsEnabled="{Binding IsOperationEnabled}"/>
                    <Button Content="書込" Width="70" Height="26" FontSize="12" Margin="0,0,6,0"
                            Style="{DynamicResource SuccessButton}"
                            Command="{Binding SaveParametersCommand}"
                            IsEnabled="{Binding IsOperationEnabled}"/>
                    <Button Content="デフォルト" Width="70" Height="26" FontSize="12"
                            Style="{DynamicResource SecondaryButton}"
                            Command="{Binding ResetDefaultCommand}"
                            IsEnabled="{Binding IsOperationEnabled}"/>
                </StackPanel>
                </Grid>
            </TabItem>

            <!-- タブ3: CAN設定 -->
            <TabItem Header="CAN設定" IsEnabled="{Binding IsFirmwareMode}">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- CANチャンネル設定 -->
                    <Border Grid.Row="0" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="10" Margin="0,0,0,8">
                        <StackPanel>
                            <TextBlock Text="受信チャンネル設定" FontWeight="Bold" FontSize="12" Margin="0,0,0,8" Foreground="{DynamicResource TextBrush}"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="35"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="40"/>
                                    <ColumnDefinition Width="20"/>
                                    <ColumnDefinition Width="35"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- CH1-2 -->
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="CH1" FontSize="11" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                <TextBox Grid.Row="0" Grid.Column="1" x:Name="CanCh1IdBox" Text="0x3E8" Height="22" FontSize="11" Margin="2" IsEnabled="{Binding IsOperationEnabled}"/>
                                <CheckBox Grid.Row="0" Grid.Column="2" x:Name="CanCh1EnabledBox" IsChecked="True" VerticalAlignment="Center" HorizontalAlignment="Center" IsEnabled="{Binding IsOperationEnabled}"/>
                                <TextBlock Grid.Row="0" Grid.Column="4" Text="CH2" FontSize="11" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                <TextBox Grid.Row="0" Grid.Column="5" x:Name="CanCh2IdBox" Text="0x3E9" Height="22" FontSize="11" Margin="2" IsEnabled="{Binding IsOperationEnabled}"/>
                                <CheckBox Grid.Row="0" Grid.Column="6" x:Name="CanCh2EnabledBox" IsChecked="True" VerticalAlignment="Center" HorizontalAlignment="Center" IsEnabled="{Binding IsOperationEnabled}"/>

                                <!-- CH3-4 -->
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="CH3" FontSize="11" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                <TextBox Grid.Row="1" Grid.Column="1" x:Name="CanCh3IdBox" Text="0x3EA" Height="22" FontSize="11" Margin="2" IsEnabled="{Binding IsOperationEnabled}"/>
                                <CheckBox Grid.Row="1" Grid.Column="2" x:Name="CanCh3EnabledBox" IsChecked="True" VerticalAlignment="Center" HorizontalAlignment="Center" IsEnabled="{Binding IsOperationEnabled}"/>
                                <TextBlock Grid.Row="1" Grid.Column="4" Text="CH4" FontSize="11" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                <TextBox Grid.Row="1" Grid.Column="5" x:Name="CanCh4IdBox" Text="0x3EB" Height="22" FontSize="11" Margin="2" IsEnabled="{Binding IsOperationEnabled}"/>
                                <CheckBox Grid.Row="1" Grid.Column="6" x:Name="CanCh4EnabledBox" IsChecked="True" VerticalAlignment="Center" HorizontalAlignment="Center" IsEnabled="{Binding IsOperationEnabled}"/>

                                <!-- CH5-6 -->
                                <TextBlock Grid.Row="2" Grid.Column="0" Text="CH5" FontSize="11" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                <TextBox Grid.Row="2" Grid.Column="1" x:Name="CanCh5IdBox" Text="0x3EC" Height="22" FontSize="11" Margin="2" IsEnabled="{Binding IsOperationEnabled}"/>
                                <CheckBox Grid.Row="2" Grid.Column="2" x:Name="CanCh5EnabledBox" IsChecked="True" VerticalAlignment="Center" HorizontalAlignment="Center" IsEnabled="{Binding IsOperationEnabled}"/>
                                <TextBlock Grid.Row="2" Grid.Column="4" Text="CH6" FontSize="11" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                <TextBox Grid.Row="2" Grid.Column="5" x:Name="CanCh6IdBox" Text="0x3ED" Height="22" FontSize="11" Margin="2" IsEnabled="{Binding IsOperationEnabled}"/>
                                <CheckBox Grid.Row="2" Grid.Column="6" x:Name="CanCh6EnabledBox" IsChecked="False" VerticalAlignment="Center" HorizontalAlignment="Center" IsEnabled="{Binding IsOperationEnabled}"/>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- データフィールド定義 -->
                    <Border Grid.Row="1" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="10">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="データフィールド定義 (最大8個)" FontWeight="Bold" FontSize="12" Margin="0,0,0,8" Foreground="{DynamicResource TextBrush}"/>

                            <DataGrid Grid.Row="1" x:Name="CanFieldsGrid"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      HeadersVisibility="Column"
                                      GridLinesVisibility="Horizontal"
                                      Background="Transparent"
                                      RowBackground="{DynamicResource CardBackgroundBrush}"
                                      AlternatingRowBackground="{DynamicResource PrimaryBackgroundBrush}"
                                      Foreground="{DynamicResource TextBrush}"
                                      BorderBrush="{DynamicResource BorderBrush}"
                                      FontSize="11"
                                      IsEnabled="{Binding IsOperationEnabled}">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="25" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="CH" Binding="{Binding Channel}" Width="35"/>
                                    <DataGridTextColumn Header="Byte" Binding="{Binding StartByte}" Width="40"/>
                                    <DataGridTextColumn Header="Size" Binding="{Binding ByteCount}" Width="40"/>
                                    <DataGridComboBoxColumn Header="Type" SelectedItemBinding="{Binding DataType}" Width="45">
                                        <DataGridComboBoxColumn.ElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.DataTypeOptions, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                            </Style>
                                        </DataGridComboBoxColumn.ElementStyle>
                                        <DataGridComboBoxColumn.EditingElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.DataTypeOptions, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                            </Style>
                                        </DataGridComboBoxColumn.EditingElementStyle>
                                    </DataGridComboBoxColumn>
                                    <DataGridComboBoxColumn Header="End" SelectedItemBinding="{Binding Endian}" Width="40">
                                        <DataGridComboBoxColumn.ElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.EndianOptions, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                            </Style>
                                        </DataGridComboBoxColumn.ElementStyle>
                                        <DataGridComboBoxColumn.EditingElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.EndianOptions, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                            </Style>
                                        </DataGridComboBoxColumn.EditingElementStyle>
                                    </DataGridComboBoxColumn>
                                    <DataGridComboBoxColumn Header="Var" SelectedItemBinding="{Binding TargetVarName}" Width="55">
                                        <DataGridComboBoxColumn.ElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.VarOptions, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                            </Style>
                                        </DataGridComboBoxColumn.ElementStyle>
                                        <DataGridComboBoxColumn.EditingElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.VarOptions, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                            </Style>
                                        </DataGridComboBoxColumn.EditingElementStyle>
                                    </DataGridComboBoxColumn>
                                    <DataGridTextColumn Header="Off" Binding="{Binding Offset}" Width="40"/>
                                    <DataGridTextColumn Header="Mul" Binding="{Binding Multiplier}" Width="50"/>
                                    <DataGridTextColumn Header="Div" Binding="{Binding Divisor}" Width="50"/>
                                    <DataGridCheckBoxColumn Header="EN" Binding="{Binding Enabled}" Width="35"/>
                                </DataGrid.Columns>
                            </DataGrid>

                            <TextBlock Grid.Row="2" Text="Type: U=Unsigned, S=Signed | End: B=Big, L=Little | Mul/Div: 1000=x1.0"
                                       FontSize="10" Foreground="{DynamicResource TextMutedBrush}" Margin="0,6,0,0"/>
                        </Grid>
                    </Border>

                    <!-- ボタンとステータス -->
                    <StackPanel Grid.Row="2" Margin="0,8,0,0">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <Button Content="読込" Width="70" Height="26" FontSize="12" Margin="0,0,6,0"
                                    Style="{DynamicResource PrimaryButton}"
                                    Click="CanReadButton_Click"
                                    IsEnabled="{Binding IsOperationEnabled}"/>
                            <Button Content="書込" Width="70" Height="26" FontSize="12" Margin="0,0,6,0"
                                    Style="{DynamicResource SuccessButton}"
                                    Click="CanWriteButton_Click"
                                    IsEnabled="{Binding IsOperationEnabled}"/>
                            <Button Content="デフォルト" Width="70" Height="26" FontSize="12"
                                    Style="{DynamicResource SecondaryButton}"
                                    Click="CanDefaultButton_Click"
                                    IsEnabled="{Binding IsOperationEnabled}"/>
                        </StackPanel>
                        <!-- ステータス表示 -->
                        <Border Background="{DynamicResource PrimaryBackgroundBrush}" CornerRadius="3" Margin="0,8,0,0" Padding="6">
                            <TextBlock x:Name="CanStatusText" Text="ボタンを押すとコマンドが送信されます"
                                       FontSize="11" Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap"/>
                        </Border>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- タブ4: 起動画面変更 -->
            <TabItem Header="起動画面変更" IsEnabled="{Binding IsFirmwareMode}">
                <views:StartupImageView DataContext="{Binding StartupImageViewModel}" />
            </TabItem>

            <!-- タブ4: ファームウェア更新 -->
            <TabItem Header="ファームウェア更新">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 現在のバージョン -->
                    <Border Grid.Row="0" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="10" Margin="0,0,0,8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="現在のファームウェア:" FontWeight="Bold" FontSize="12"
                                       VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                            <TextBlock Grid.Column="1" FontSize="14" FontWeight="Bold" Margin="8,0,0,0" VerticalAlignment="Center"
                                       Foreground="#2ECC71">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="{Binding FirmwareVersion, StringFormat=v{0}}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding FirmwareVersion}" Value="">
                                                <Setter Property="Text" Value="未取得"/>
                                                <Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </Border>

                    <!-- ファイル選択 -->
                    <Border Grid.Row="1" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="10" Margin="0,0,0,8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding FirmwareFilePath}" IsReadOnly="True"
                                     Height="24" FontSize="12" Margin="0,0,6,0" VerticalContentAlignment="Center"/>
                            <Button Grid.Column="1" Content="参照..." Width="60" Height="24" FontSize="12"
                                    Style="{DynamicResource SecondaryButton}"
                                    Command="{Binding BrowseFirmwareCommand}"
                                    IsEnabled="{Binding IsConnected}"/>
                        </Grid>
                    </Border>

                    <!-- 進捗表示 -->
                    <Border Grid.Row="2" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="10" Margin="0,0,0,8">
                        <StackPanel>
                            <TextBlock Text="転送進捗" FontWeight="Bold" FontSize="12" Margin="0,0,0,6" Foreground="{DynamicResource TextBrush}"/>
                            <ProgressBar Height="20" Value="{Binding FirmwareProgress}" Maximum="100" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding FirmwareStatus}" FontSize="12" Foreground="{DynamicResource TextMutedBrush}"/>
                        </StackPanel>
                    </Border>

                    <!-- 通信ログ -->
                    <Border Grid.Row="3" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="10,10,10,6" Margin="0,0,0,8">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                                <TextBlock Text="通信ログ" FontWeight="Bold" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                                <Button Content="クリア" Width="60" Height="20" FontSize="12" Margin="10,0,0,0"
                                        Style="{DynamicResource OutlineButton}"
                                        Command="{Binding ClearFirmwareLogCommand}"
                                        IsEnabled="{Binding IsConnected}"/>
                                <Button Content="コピー" Width="60" Height="20" FontSize="12" Margin="6,0,0,0"
                                        Style="{DynamicResource OutlineButton}"
                                        Command="{Binding CopyFirmwareLogCommand}"
                                        IsEnabled="{Binding IsConnected}"/>
                            </StackPanel>
                            <TextBox Grid.Row="1" Text="{Binding FirmwareLog, Mode=OneWay}"
                                     x:Name="FirmwareLogTextBox"
                                     Height="140" FontSize="12" FontFamily="Consolas"
                                     IsReadOnly="True" TextWrapping="Wrap"
                                     VerticalScrollBarVisibility="Auto"
                                     Background="#1E1E1E" Foreground="#DCDCDC"
                                     Padding="6"
                                     TextChanged="FirmwareLogTextBox_TextChanged"/>
                        </Grid>
                    </Border>

                    <!-- 更新ボタン -->
                    <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,6,0,0">
                        <Button Content="ファームウェア更新開始" Width="160" Height="32" FontSize="12"
                                Style="{DynamicResource WarningButton}"
                                Command="{Binding StartFirmwareUpdateCommand}"
                                IsEnabled="{Binding CanStartFirmwareUpdate}"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- Aboutタブ -->
            <TabItem Header="About">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Loaded="AboutScrollViewer_Loaded">
                    <StackPanel Margin="16">
                        <!-- ロゴ -->
                        <Image Source="Assets/FM1.png" Width="200" Height="200" Margin="0,0,0,16"
                               RenderOptions.BitmapScalingMode="HighQuality"/>

                        <!-- アプリ名 -->
                        <TextBlock Text="FULLMONI-WIDE Terminal" FontSize="20" FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   HorizontalAlignment="Center" Margin="0,0,0,4"/>

                        <!-- バージョン -->
                        <TextBlock Text="{Binding AppVersion, StringFormat=Version {0}}" FontSize="12"
                                   Foreground="{DynamicResource TextMutedBrush}"
                                   HorizontalAlignment="Center" Margin="0,0,0,16"/>

                        <!-- 説明 -->
                        <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="12" Margin="0,0,0,12">
                            <StackPanel>
                                <TextBlock Text="概要" FontSize="14" FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                                <TextBlock TextWrapping="Wrap" FontSize="12"
                                           Foreground="{DynamicResource TextSecondaryBrush}">
                                    FULLMONI-WIDEファームウェアとUART通信するためのWindowsホストアプリケーションです。
                                    パラメータの設定・保存、ファームウェアの更新などが行えます。
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <!-- 開発情報 -->
                        <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="12" Margin="0,0,0,12">
                            <StackPanel>
                                <TextBlock Text="開発情報" FontSize="14" FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="フレームワーク" FontSize="12"
                                               Foreground="{DynamicResource TextMutedBrush}"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text=".NET 8.0 WPF" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="アーキテクチャ" FontSize="12"
                                               Foreground="{DynamicResource TextMutedBrush}" Margin="0,4,0,0"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="MVVM (CommunityToolkit.Mvvm)" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,4,0,0"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="通信設定" FontSize="12"
                                               Foreground="{DynamicResource TextMutedBrush}" Margin="0,4,0,0"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" Text="115200bps, 8N1, XON/XOFF" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,4,0,0"/>

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="ライセンス" FontSize="12"
                                               Foreground="{DynamicResource TextMutedBrush}" Margin="0,4,0,0"/>
                                    <TextBlock Grid.Row="3" Grid.Column="1" Text="MIT License" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,4,0,0"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- リンク -->
                        <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="4" Padding="12">
                            <StackPanel>
                                <TextBlock Text="リンク" FontSize="14" FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,8"/>

                                <Button Content="🔗 GitHub リポジトリ"
                                        Style="{DynamicResource LinkButton}"
                                        Click="OpenGitHubLink_Click"
                                        HorizontalAlignment="Left" Margin="0,0,0,4"/>

                                <Button Content="📖 ドキュメント"
                                        Style="{DynamicResource LinkButton}"
                                        Click="OpenDocsLink_Click"
                                        HorizontalAlignment="Left" Margin="0,0,0,4"/>

                                <Button Content="🐛 Issue報告"
                                        Style="{DynamicResource LinkButton}"
                                        Click="OpenIssuesLink_Click"
                                        HorizontalAlignment="Left"/>
                            </StackPanel>
                        </Border>

                        <!-- コピーライト -->
                        <TextBlock Text="© 2024-2026 FULLMONI-WIDE Project" FontSize="11"
                                   Foreground="{DynamicResource TextMutedBrush}"
                                   HorizontalAlignment="Center" Margin="0,16,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- ステータス -->
        <TextBlock Grid.Row="2" Text="{Binding ActivityStatus}" FontSize="12"
                   Foreground="{DynamicResource TextMutedBrush}"
                   HorizontalAlignment="Center"/>
    </Grid>
</Window>
