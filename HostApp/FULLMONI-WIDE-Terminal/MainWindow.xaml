<ui:FluentWindow x:Class="FullmoniTerminal.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:local="clr-namespace:FullmoniTerminal"
        xmlns:vm="clr-namespace:FullmoniTerminal.ViewModels"
        xmlns:views="clr-namespace:FullmoniTerminal.Views"
        mc:Ignorable="d"
        Title="FULLMONI-WIDE Terminal"
        Height="700" Width="900"
        MinHeight="600" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Acrylic"
        Icon="Assets/FMW.ico"
        Closing="Window_Closing">

    <ui:FluentWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
        <local:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <local:NullToBoolConverter x:Key="NullToBoolConverter"/>
        <local:BoolToBorderBrushConverter x:Key="BoolToBorderBrushConverter"/>

        <!-- アクセントカラー -->
        <SolidColorBrush x:Key="AccentBrush" Color="#0078D4"/>
        <SolidColorBrush x:Key="AccentBrushLight" Color="#1E90FF"/>
        <SolidColorBrush x:Key="SidebarBrush" Color="#1A1A2E"/>
        <SolidColorBrush x:Key="CardBorderBrush" Color="#2D2D44"/>

        <!-- DataGrid内チェックボックスの縮小スケール -->
        <ScaleTransform x:Key="DataGridCheckBoxScale" ScaleX="0.7" ScaleY="0.7"/>
    </ui:FluentWindow.Resources>

    <ui:FluentWindow.DataContext>
        <vm:MainViewModel/>
    </ui:FluentWindow.DataContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- タイトルバー -->
        <ui:TitleBar Grid.Row="0" Title="FULLMONI-WIDE Terminal" ShowMaximize="True"/>

        <!-- メインコンテンツ -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="220"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- サイドバー -->
            <Border Grid.Column="0" Padding="12">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#1A1A2E" Offset="0"/>
                        <GradientStop Color="#16213E" Offset="1"/>
                    </LinearGradientBrush>
                </Border.Background>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Connection -->
                    <StackPanel Grid.Row="0" Margin="0,0,0,16">
                        <TextBlock Text="Connection" FontWeight="SemiBold" Margin="4,0,0,8" Foreground="#0078D4"/>
                        <ComboBox ItemsSource="{Binding AvailablePorts}"
                                  SelectedItem="{Binding SelectedPort}"
                                  Margin="0,0,0,8"
                                  IsEnabled="{Binding IsNotConnected}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <ui:Button Grid.Column="0" Content="Refresh" Margin="0,0,4,0"
                                       Command="{Binding RefreshPortsCommand}"
                                       IsEnabled="{Binding IsNotConnected}"
                                       HorizontalAlignment="Stretch"/>
                            <ui:Button Grid.Column="1" Content="{Binding ConnectionButtonText}" Margin="4,0,0,0"
                                       Appearance="Primary"
                                       Command="{Binding ConnectCommand}"
                                       IsEnabled="{Binding CanCloseWindow}"
                                       HorizontalAlignment="Stretch"/>
                        </Grid>

                        <!-- 接続状態 -->
                        <StackPanel Orientation="Horizontal" Margin="4,12,0,0">
                            <Ellipse Width="10" Height="10" Margin="0,0,8,0">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="#E74C3C"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                                <Setter Property="Fill" Value="#4CAF50"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <TextBlock Text="{Binding StatusText}" FontSize="12"/>
                        </StackPanel>
                        <TextBlock Text="{Binding FirmwareVersion, StringFormat=FW: v{0}}" FontSize="11" Opacity="0.5" Margin="22,4,0,0"
                                   Visibility="{Binding IsConnected, Converter={StaticResource BoolToVisibility}}"/>
                    </StackPanel>

                    <Separator Grid.Row="1" Margin="0,0,0,12"/>

                    <!-- Navigation Menu -->
                    <StackPanel Grid.Row="2">
                        <ui:Button x:Name="NavHome" HorizontalAlignment="Stretch"
                                   HorizontalContentAlignment="Left" Margin="0,2" Padding="12,10" Click="NavButton_Click"
                                   Tag="home" Appearance="Primary" Icon="{ui:SymbolIcon Home24}" Content="Home"/>
                        <ui:Button x:Name="NavStatus" HorizontalAlignment="Stretch"
                                   HorizontalContentAlignment="Left" Margin="0,2" Padding="12,10" Click="NavButton_Click"
                                   Tag="status" IsEnabled="{Binding IsFirmwareMode}" Icon="{ui:SymbolIcon Gauge24}" Content="Status"/>
                        <ui:Button x:Name="NavSettings" HorizontalAlignment="Stretch"
                                   HorizontalContentAlignment="Left" Margin="0,2" Padding="12,10" Click="NavButton_Click"
                                   Tag="settings" IsEnabled="{Binding IsFirmwareMode}" Icon="{ui:SymbolIcon Settings24}" Content="Settings"/>
                        <ui:Button x:Name="NavCan" HorizontalAlignment="Stretch"
                                   HorizontalContentAlignment="Left" Margin="0,2" Padding="12,10" Click="NavButton_Click"
                                   Tag="can" IsEnabled="{Binding IsFirmwareMode}" Icon="{ui:SymbolIcon PlugConnected24}" Content="CAN Config"/>
                        <ui:Button x:Name="NavStartup" HorizontalAlignment="Stretch"
                                   HorizontalContentAlignment="Left" Margin="0,2" Padding="12,10" Click="NavButton_Click"
                                   Tag="startup" IsEnabled="{Binding IsFirmwareMode}" Icon="{ui:SymbolIcon Image24}" Content="Boot Screen"/>
                        <ui:Button x:Name="NavFirmware" HorizontalAlignment="Stretch"
                                   HorizontalContentAlignment="Left" Margin="0,2" Padding="12,10" Click="NavButton_Click"
                                   Tag="firmware" Icon="{ui:SymbolIcon ArrowDownload24}" Content="FW Update"/>
                    </StackPanel>

                    <!-- About -->
                    <ui:Button Grid.Row="3" x:Name="NavAbout" HorizontalAlignment="Stretch"
                               HorizontalContentAlignment="Left" Margin="0,8,0,0" Padding="12,10" Click="NavButton_Click"
                               Tag="about" Icon="{ui:SymbolIcon Info24}" Content="About"/>
                </Grid>
            </Border>

            <!-- コンテンツエリア -->
            <Border Grid.Column="1">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#0D1B2A" Offset="0"/>
                        <GradientStop Color="#1B263B" Offset="0.5"/>
                        <GradientStop Color="#0D1B2A" Offset="1"/>
                    </LinearGradientBrush>
                </Border.Background>
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid x:Name="ContentArea" Margin="24">

                    <!-- ホームページ（グラフィカルなダッシュボード） -->
                    <StackPanel x:Name="HomePage" Visibility="Visible">
                        <!-- ヒーローバナー -->
                        <Border CornerRadius="16" Margin="0,0,0,24" ClipToBounds="True">
                            <Grid Height="280">
                                <!-- CAD背景画像 (FM3.png) -->
                                <Image x:Name="HeroImage1" Source="Assets/FM3.png" Stretch="UniformToFill" Opacity="0.35"
                                       HorizontalAlignment="Right" Margin="0,0,-100,0"/>

                                <!-- 実機画像 (FM2.png) -->
                                <Image x:Name="HeroImage2" Source="Assets/FM2.png" Stretch="UniformToFill" Opacity="0"
                                       HorizontalAlignment="Right" Margin="0,0,-100,0"/>

                                <!-- グラデーションオーバーレイ -->
                                <Border>
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0.3">
                                            <GradientStop Color="#0891B2" Offset="0"/>
                                            <GradientStop Color="#0891B2" Offset="0.3"/>
                                            <GradientStop Color="#0E7490" Offset="0.6"/>
                                            <GradientStop Color="#06475F" Offset="1"/>
                                        </LinearGradientBrush>
                                    </Border.Background>
                                    <Border.OpacityMask>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                            <GradientStop Color="#FF000000" Offset="0"/>
                                            <GradientStop Color="#FF000000" Offset="0.4"/>
                                            <GradientStop Color="#80000000" Offset="0.7"/>
                                            <GradientStop Color="#00000000" Offset="1"/>
                                        </LinearGradientBrush>
                                    </Border.OpacityMask>
                                </Border>

                                <!-- メインコンテンツ -->
                                <StackPanel VerticalAlignment="Center" Margin="40,0,0,0">
                                    <TextBlock Text="RX72N Multimeter" FontSize="14" Foreground="#E0F2FE" Opacity="0.9"/>
                                    <TextBlock Text="FULLMONI-WIDE" FontSize="42" FontWeight="Bold" Foreground="White" Margin="0,4,0,8"/>
                                    <TextBlock Text="Build your custom automotive display with CAN bus integration."
                                               FontSize="16" Foreground="#E0F2FE" Opacity="0.9" Margin="0,0,0,20"/>
                                    <ui:Button x:Name="HeroConnectButton" Content="{Binding HeroButtonText}"
                                               Appearance="Light" Icon="{ui:SymbolIcon PlugConnected24}"
                                               Padding="20,12" FontSize="14"
                                               Click="HeroConnectButton_Click"/>
                                </StackPanel>

                                <!-- ステータスバッジ -->
                                <Border CornerRadius="8" Background="#0E7490" Padding="12,8"
                                        HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,20,20,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Ellipse Width="10" Height="10" Margin="0,0,8,0">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Fill" Value="#EF4444"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                                            <Setter Property="Fill" Value="#22C55E"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>
                                        <TextBlock Text="{Binding StatusText}" Foreground="White" FontWeight="Medium"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </Border>

                        <!-- Feature Cards -->
                        <ui:TextBlock Text="Quick Access" FontTypography="Subtitle" Margin="0,0,0,16"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- ステータスカード -->
                            <ui:CardAction Grid.Column="0" Margin="0,0,8,0" Click="NavCard_Click" Tag="status"
                                           IsEnabled="{Binding IsFirmwareMode}">
                                <Grid Margin="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Border Grid.Row="0" Width="48" Height="48" CornerRadius="12" Background="#3B82F6" HorizontalAlignment="Left" Margin="0,0,0,12">
                                        <ui:SymbolIcon Symbol="Gauge24" FontSize="24" Foreground="White"/>
                                    </Border>
                                    <ui:TextBlock Grid.Row="1" Text="Status" FontTypography="BodyStrong"/>
                                    <ui:TextBlock Grid.Row="2" Text="ODO/TRIP/Clock" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardAction>

                            <!-- 設定カード -->
                            <ui:CardAction Grid.Column="1" Margin="4,0" Click="NavCard_Click" Tag="settings"
                                           IsEnabled="{Binding IsFirmwareMode}">
                                <Grid Margin="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Border Grid.Row="0" Width="48" Height="48" CornerRadius="12" Background="#10B981" HorizontalAlignment="Left" Margin="0,0,0,12">
                                        <ui:SymbolIcon Symbol="Settings24" FontSize="24" Foreground="White"/>
                                    </Border>
                                    <ui:TextBlock Grid.Row="1" Text="Settings" FontTypography="BodyStrong"/>
                                    <ui:TextBlock Grid.Row="2" Text="Tire/Gear/Warnings" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardAction>

                            <!-- CANカード -->
                            <ui:CardAction Grid.Column="2" Margin="4,0" Click="NavCard_Click" Tag="can"
                                           IsEnabled="{Binding IsFirmwareMode}">
                                <Grid Margin="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Border Grid.Row="0" Width="48" Height="48" CornerRadius="12" Background="#F59E0B" HorizontalAlignment="Left" Margin="0,0,0,12">
                                        <ui:SymbolIcon Symbol="PlugConnected24" FontSize="24" Foreground="White"/>
                                    </Border>
                                    <ui:TextBlock Grid.Row="1" Text="CAN Config" FontTypography="BodyStrong"/>
                                    <ui:TextBlock Grid.Row="2" Text="Channels/Fields" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardAction>

                            <!-- 起動画面カード -->
                            <ui:CardAction Grid.Column="3" Margin="8,0,0,0" Click="NavCard_Click" Tag="startup"
                                           IsEnabled="{Binding IsFirmwareMode}">
                                <Grid Margin="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Border Grid.Row="0" Width="48" Height="48" CornerRadius="12" Background="#8B5CF6" HorizontalAlignment="Left" Margin="0,0,0,12">
                                        <ui:SymbolIcon Symbol="Image24" FontSize="24" Foreground="White"/>
                                    </Border>
                                    <ui:TextBlock Grid.Row="1" Text="Boot Screen" FontTypography="BodyStrong"/>
                                    <ui:TextBlock Grid.Row="2" Text="Custom Image" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardAction>
                        </Grid>

                        <!-- 下段カード -->
                        <Grid Margin="0,12,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- FW更新カード -->
                            <ui:CardAction Grid.Column="0" Margin="0,0,6,0" Click="NavCard_Click" Tag="firmware">
                                <Grid Margin="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Border Grid.Row="0" Width="48" Height="48" CornerRadius="12" Background="#EF4444" HorizontalAlignment="Left" Margin="0,0,0,12">
                                        <ui:SymbolIcon Symbol="ArrowDownload24" FontSize="24" Foreground="White"/>
                                    </Border>
                                    <ui:TextBlock Grid.Row="1" Text="FW Update" FontTypography="BodyStrong"/>
                                    <ui:TextBlock Grid.Row="2" Text="Update device firmware" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardAction>

                            <!-- Aboutカード -->
                            <ui:CardAction Grid.Column="1" Margin="6,0,0,0" Click="NavCard_Click" Tag="about">
                                <Grid Margin="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Border Grid.Row="0" Width="48" Height="48" CornerRadius="12" Background="#6366F1" HorizontalAlignment="Left" Margin="0,0,0,12">
                                        <ui:SymbolIcon Symbol="Info24" FontSize="24" Foreground="White"/>
                                    </Border>
                                    <ui:TextBlock Grid.Row="1" Text="About" FontTypography="BodyStrong"/>
                                    <ui:TextBlock Grid.Row="2" Text="Version info &amp; License" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardAction>
                        </Grid>

                        <!-- Footer Info -->
                        <Border Margin="0,24,0,0" Padding="16" CornerRadius="8" Background="#1E293B">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <ui:TextBlock Text="Connected Device" FontTypography="BodyStrong" Margin="0,0,0,4"/>
                                    <TextBlock Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}">
                                        <Run Text="Port: "/><Run Text="{Binding ConnectedPort, FallbackValue=Not connected, Mode=OneWay}"/>
                                        <Run Text="  |  FW: "/><Run Text="{Binding FirmwareVersion, FallbackValue=---, Mode=OneWay}"/>
                                    </TextBlock>
                                </StackPanel>
                                <ui:Button Grid.Column="1" Content="View Details" Click="NavCard_Click" Tag="status"
                                           IsEnabled="{Binding IsFirmwareMode}"/>
                            </Grid>
                        </Border>
                    </StackPanel>

                    <!-- Status Page -->
                    <StackPanel x:Name="StatusPage" Visibility="Collapsed">
                        <ui:TextBlock Text="Status" FontTypography="Subtitle" Margin="0,0,0,16"/>

                        <ui:CardExpander Icon="{ui:SymbolIcon Gauge24}" IsExpanded="True" Margin="0,0,0,8">
                            <ui:CardExpander.Header>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <ui:TextBlock Grid.Row="0" Text="Meter Info" FontTypography="Body"/>
                                    <ui:TextBlock Grid.Row="1" Text="View and configure ODO/TRIP/DateTime" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardExpander.Header>
                            <Grid Margin="16,8,16,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="48"/>
                                    <RowDefinition Height="48"/>
                                    <RowDefinition Height="48"/>
                                </Grid.RowDefinitions>

                                <ui:TextBlock Grid.Row="0" Grid.Column="0" Text="ODO" FontWeight="SemiBold" VerticalAlignment="Center" FontSize="16"/>
                                <ui:TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding OdoValue, StringFormat={}{0} km}" VerticalAlignment="Center" FontSize="16" FontWeight="Medium"/>

                                <ui:TextBlock Grid.Row="1" Grid.Column="0" Text="TRIP" FontWeight="SemiBold" VerticalAlignment="Center" FontSize="16"/>
                                <ui:TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TripValue, StringFormat={}{0} km}" VerticalAlignment="Center" FontSize="16" FontWeight="Medium"/>
                                <ui:Button Grid.Row="1" Grid.Column="2" Content="RESET"
                                           Command="{Binding ResetTripCommand}"
                                           IsEnabled="{Binding IsOperationEnabled}"/>

                                <ui:TextBlock Grid.Row="2" Grid.Column="0" Text="DateTime" FontWeight="SemiBold" VerticalAlignment="Center" FontSize="16"/>
                                <ui:TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding RtcValue}" VerticalAlignment="Center" FontSize="16" FontWeight="Medium"/>
                                <ui:Button Grid.Row="2" Grid.Column="2" Content="Sync with PC"
                                           Command="{Binding SyncRtcCommand}"
                                           IsEnabled="{Binding IsOperationEnabled}"/>
                            </Grid>
                        </ui:CardExpander>

                        <ui:Button Content="Reload" Appearance="Primary" Icon="{ui:SymbolIcon ArrowSync24}"
                                   Command="{Binding LoadParametersCommand}"
                                   IsEnabled="{Binding IsOperationEnabled}"
                                   HorizontalAlignment="Center" Margin="0,16,0,0"/>
                    </StackPanel>

                    <!-- Settings Page -->
                    <StackPanel x:Name="SettingsPage" Visibility="Collapsed">
                        <ui:TextBlock Text="Vehicle Settings" FontTypography="BodyStrong" Margin="0,0,0,12"/>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="16"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- 左カラム -->
                            <StackPanel Grid.Column="0">
                                <ui:CardExpander Icon="{ui:SymbolIcon Circle24}" IsExpanded="True" Margin="0,0,0,8">
                                    <ui:CardExpander.Header>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <ui:TextBlock Grid.Row="0" Text="Tire Size" FontTypography="Body"/>
                                            <ui:TextBlock Grid.Row="1" Text="Tire diameter for speed calculation" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                        </Grid>
                                    </ui:CardExpander.Header>
                                    <Grid Margin="16,8,16,16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <ui:TextBlock Grid.Row="0" Grid.Column="0" Text="Width" VerticalAlignment="Center"/>
                                        <ui:TextBox Grid.Row="0" Grid.Column="1" Text="{Binding TyreWidth}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="0" Grid.Column="2" Text="mm" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <ui:TextBlock Grid.Row="1" Grid.Column="0" Text="Aspect" VerticalAlignment="Center"/>
                                        <ui:TextBox Grid.Row="1" Grid.Column="1" Text="{Binding TyreAspect}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="1" Grid.Column="2" Text="%" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <ui:TextBlock Grid.Row="2" Grid.Column="0" Text="Diameter" VerticalAlignment="Center"/>
                                        <ui:TextBox Grid.Row="2" Grid.Column="1" Text="{Binding WheelDia}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="2" Grid.Column="2" Text="inch" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                    </Grid>
                                </ui:CardExpander>

                                <ui:CardExpander Icon="{ui:SymbolIcon VehicleCarProfileLtr24}" IsExpanded="True">
                                    <ui:CardExpander.Header>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <ui:TextBlock Grid.Row="0" Text="Gear Ratio" FontTypography="Body"/>
                                            <ui:TextBlock Grid.Row="1" Text="Used for gear position calculation" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                        </Grid>
                                    </ui:CardExpander.Header>
                                    <StackPanel Margin="16,8,16,16">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="80"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <ui:TextBlock Text="Preset" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="1" ItemsSource="{Binding GearPresets}" SelectedItem="{Binding SelectedGearPreset}" IsEnabled="{Binding IsOperationEnabled}"/>
                                        </Grid>
                                        <Grid Margin="0,12,0,0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="80"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <ui:TextBlock Grid.Row="0" Grid.Column="0" Text="1st" VerticalAlignment="Center"/>
                                            <ui:TextBox Grid.Row="0" Grid.Column="1" Text="{Binding Gear1}" Margin="0,3" IsEnabled="{Binding IsOperationEnabled}"/>

                                            <ui:TextBlock Grid.Row="1" Grid.Column="0" Text="2nd" VerticalAlignment="Center"/>
                                            <ui:TextBox Grid.Row="1" Grid.Column="1" Text="{Binding Gear2}" Margin="0,3" IsEnabled="{Binding IsOperationEnabled}"/>

                                            <ui:TextBlock Grid.Row="2" Grid.Column="0" Text="3rd" VerticalAlignment="Center"/>
                                            <ui:TextBox Grid.Row="2" Grid.Column="1" Text="{Binding Gear3}" Margin="0,3" IsEnabled="{Binding IsOperationEnabled}"/>

                                            <ui:TextBlock Grid.Row="3" Grid.Column="0" Text="4th" VerticalAlignment="Center"/>
                                            <ui:TextBox Grid.Row="3" Grid.Column="1" Text="{Binding Gear4}" Margin="0,3" IsEnabled="{Binding IsOperationEnabled}"/>

                                            <ui:TextBlock Grid.Row="4" Grid.Column="0" Text="5th" VerticalAlignment="Center"/>
                                            <ui:TextBox Grid.Row="4" Grid.Column="1" Text="{Binding Gear5}" Margin="0,3" IsEnabled="{Binding IsOperationEnabled}"/>

                                            <ui:TextBlock Grid.Row="5" Grid.Column="0" Text="6th" VerticalAlignment="Center"/>
                                            <ui:TextBox Grid.Row="5" Grid.Column="1" Text="{Binding Gear6}" Margin="0,3" IsEnabled="{Binding IsOperationEnabled}"/>

                                            <ui:TextBlock Grid.Row="6" Grid.Column="0" Text="Final" VerticalAlignment="Center" Foreground="#FFD54F" FontWeight="SemiBold"/>
                                            <ui:TextBox Grid.Row="6" Grid.Column="1" Text="{Binding FinalGear}" Margin="0,3" IsEnabled="{Binding IsOperationEnabled}"/>
                                        </Grid>
                                    </StackPanel>
                                </ui:CardExpander>
                            </StackPanel>

                            <!-- 右カラム -->
                            <StackPanel Grid.Column="2">
                                <ui:CardExpander Icon="{ui:SymbolIcon Warning24}" IsExpanded="True" Margin="0,0,0,8">
                                    <ui:CardExpander.Header>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <ui:TextBlock Grid.Row="0" Text="Warning Settings" FontTypography="Body"/>
                                            <ui:TextBlock Grid.Row="1" Text="Water temp &amp; fuel warning thresholds" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                        </Grid>
                                    </ui:CardExpander.Header>
                                    <Grid Margin="16,8,16,16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="90"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="40"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <ui:TextBlock Grid.Row="0" Grid.Column="0" Text="Water Low" VerticalAlignment="Center" Foreground="#64B5F6"/>
                                        <ui:TextBox Grid.Row="0" Grid.Column="1" Text="{Binding WaterTempLow}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="0" Grid.Column="2" Text="°C" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <ui:TextBlock Grid.Row="1" Grid.Column="0" Text="Water High" VerticalAlignment="Center" Foreground="#E57373"/>
                                        <ui:TextBox Grid.Row="1" Grid.Column="1" Text="{Binding WaterTempHigh}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="1" Grid.Column="2" Text="°C" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <ui:TextBlock Grid.Row="2" Grid.Column="0" Text="Fuel Warn" VerticalAlignment="Center" Foreground="#FFD54F"/>
                                        <ui:TextBox Grid.Row="2" Grid.Column="1" Text="{Binding FuelWarn}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="2" Grid.Column="2" Text="L" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                    </Grid>
                                </ui:CardExpander>

                                <ui:CardExpander Icon="{ui:SymbolIcon TopSpeed24}" IsExpanded="True">
                                    <ui:CardExpander.Header>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <ui:TextBlock Grid.Row="0" Text="Shift Indicator" FontTypography="Body"/>
                                            <ui:TextBlock Grid.Row="1" Text="Shift lamp activation RPM" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                        </Grid>
                                    </ui:CardExpander.Header>
                                    <Grid Margin="16,8,16,16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="90"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="40"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <ui:TextBlock Grid.Row="0" Grid.Column="0" Text="Stage 1" VerticalAlignment="Center" Foreground="#64B5F6" FontWeight="SemiBold"/>
                                        <ui:TextBox Grid.Row="0" Grid.Column="1" Text="{Binding ShiftRpm1}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="0" Grid.Column="2" Text="rpm" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <ui:TextBlock Grid.Row="1" Grid.Column="0" Text="Stage 2" VerticalAlignment="Center" Foreground="#64B5F6" FontWeight="SemiBold"/>
                                        <ui:TextBox Grid.Row="1" Grid.Column="1" Text="{Binding ShiftRpm2}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="1" Grid.Column="2" Text="rpm" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <ui:TextBlock Grid.Row="2" Grid.Column="0" Text="Stage 3" VerticalAlignment="Center" Foreground="#81C784" FontWeight="SemiBold"/>
                                        <ui:TextBox Grid.Row="2" Grid.Column="1" Text="{Binding ShiftRpm3}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="2" Grid.Column="2" Text="rpm" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <ui:TextBlock Grid.Row="3" Grid.Column="0" Text="Stage 4" VerticalAlignment="Center" Foreground="#E57373" FontWeight="SemiBold"/>
                                        <ui:TextBox Grid.Row="3" Grid.Column="1" Text="{Binding ShiftRpm4}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="3" Grid.Column="2" Text="rpm" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <ui:TextBlock Grid.Row="4" Grid.Column="0" Text="Flash" VerticalAlignment="Center" Foreground="#FFFFFF" FontWeight="SemiBold"/>
                                        <ui:TextBox Grid.Row="4" Grid.Column="1" Text="{Binding ShiftRpm5}" Margin="0,4" IsEnabled="{Binding IsOperationEnabled}"/>
                                        <ui:TextBlock Grid.Row="4" Grid.Column="2" Text="rpm" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                    </Grid>
                                </ui:CardExpander>
                            </StackPanel>
                        </Grid>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,24,0,0">
                            <ui:Button Content="Reload" Margin="0,0,8,0" Icon="{ui:SymbolIcon ArrowSync24}"
                                       Command="{Binding LoadParametersCommand}"
                                       IsEnabled="{Binding IsOperationEnabled}"/>
                            <ui:Button Content="Save" Appearance="Primary" Margin="0,0,8,0" Icon="{ui:SymbolIcon Save24}"
                                       Command="{Binding SaveParametersCommand}"
                                       IsEnabled="{Binding IsOperationEnabled}"/>
                            <ui:Button Content="Default" Icon="{ui:SymbolIcon ArrowReset24}"
                                       Command="{Binding ResetDefaultCommand}"
                                       IsEnabled="{Binding IsOperationEnabled}"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- CAN Config Page -->
                    <StackPanel x:Name="CanPage" Visibility="Collapsed">
                        <ui:TextBlock Text="CAN Communication Settings" FontTypography="BodyStrong" Margin="0,0,0,12"/>

                        <ui:CardExpander Icon="{ui:SymbolIcon Warning24}" IsExpanded="True" Margin="0,0,0,8">
                            <ui:CardExpander.Header>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <ui:TextBlock Grid.Row="0" Text="Master Warning Settings" FontTypography="Body"/>
                                    <ui:TextBlock Grid.Row="1" Text="Enable warning display based on CAN values" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardExpander.Header>
                            <StackPanel Orientation="Horizontal" Margin="16,8,16,16">
                                <CheckBox x:Name="WarningEnabledBox" Content="Enable" Margin="0,0,24,0"/>
                                <CheckBox x:Name="SoundEnabledBox" Content="Sound"/>
                            </StackPanel>
                        </ui:CardExpander>

                        <ui:CardExpander Icon="{ui:SymbolIcon Channel24}" IsExpanded="True" Margin="0,0,0,8">
                            <ui:CardExpander.Header>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <ui:TextBlock Grid.Row="0" Text="Receive Channel Settings" FontTypography="Body"/>
                                    <ui:TextBlock Grid.Row="1" Text="Configure up to 6 CAN IDs" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardExpander.Header>
                            <Grid Margin="16,8,16,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" Margin="0,4">
                                    <ui:TextBlock Text="CH1" Width="40" VerticalAlignment="Center" Foreground="#64B5F6" FontWeight="SemiBold"/>
                                    <ui:TextBox x:Name="CanCh1IdBox" Width="80" Margin="4,0" PlaceholderText="0x000"/>
                                    <CheckBox x:Name="CanCh1EnabledBox" ToolTip="Enable/Disable"/>
                                </StackPanel>
                                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Margin="0,4">
                                    <ui:TextBlock Text="CH2" Width="40" VerticalAlignment="Center" Foreground="#64B5F6" FontWeight="SemiBold"/>
                                    <ui:TextBox x:Name="CanCh2IdBox" Width="80" Margin="4,0" PlaceholderText="0x000"/>
                                    <CheckBox x:Name="CanCh2EnabledBox" ToolTip="Enable/Disable"/>
                                </StackPanel>
                                <StackPanel Grid.Row="0" Grid.Column="2" Orientation="Horizontal" Margin="0,4">
                                    <ui:TextBlock Text="CH3" Width="40" VerticalAlignment="Center" Foreground="#64B5F6" FontWeight="SemiBold"/>
                                    <ui:TextBox x:Name="CanCh3IdBox" Width="80" Margin="4,0" PlaceholderText="0x000"/>
                                    <CheckBox x:Name="CanCh3EnabledBox" ToolTip="Enable/Disable"/>
                                </StackPanel>
                                <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Horizontal" Margin="0,4">
                                    <ui:TextBlock Text="CH4" Width="40" VerticalAlignment="Center" Foreground="#81C784" FontWeight="SemiBold"/>
                                    <ui:TextBox x:Name="CanCh4IdBox" Width="80" Margin="4,0" PlaceholderText="0x000"/>
                                    <CheckBox x:Name="CanCh4EnabledBox" ToolTip="Enable/Disable"/>
                                </StackPanel>
                                <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Margin="0,4">
                                    <ui:TextBlock Text="CH5" Width="40" VerticalAlignment="Center" Foreground="#81C784" FontWeight="SemiBold"/>
                                    <ui:TextBox x:Name="CanCh5IdBox" Width="80" Margin="4,0" PlaceholderText="0x000"/>
                                    <CheckBox x:Name="CanCh5EnabledBox" ToolTip="Enable/Disable"/>
                                </StackPanel>
                                <StackPanel Grid.Row="1" Grid.Column="2" Orientation="Horizontal" Margin="0,4">
                                    <ui:TextBlock Text="CH6" Width="40" VerticalAlignment="Center" Foreground="#81C784" FontWeight="SemiBold"/>
                                    <ui:TextBox x:Name="CanCh6IdBox" Width="80" Margin="4,0" PlaceholderText="0x000"/>
                                    <CheckBox x:Name="CanCh6EnabledBox" ToolTip="Enable/Disable"/>
                                </StackPanel>
                            </Grid>
                        </ui:CardExpander>

                        <ui:CardExpander Icon="{ui:SymbolIcon DataPie24}" IsExpanded="True" Margin="0,0,0,8">
                            <ui:CardExpander.Header>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <ui:TextBlock Grid.Row="0" Text="Data Field Definitions (Max 16)" FontTypography="Body"/>
                                    <ui:TextBlock Grid.Row="1" Text="Define how to parse CAN data" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardExpander.Header>
                            <StackPanel Margin="16,8,16,16">
                                <DataGrid x:Name="CanFieldsGrid"
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False"
                                          CanUserDeleteRows="False"
                                          Height="280"
                                          Background="#1A2332"
                                          RowBackground="#1E2A3A"
                                          AlternatingRowBackground="#243040"
                                          GridLinesVisibility="All"
                                          HorizontalGridLinesBrush="#3A4A5A"
                                          VerticalGridLinesBrush="#3A4A5A"
                                          BorderBrush="#4A5A6A"
                                          BorderThickness="1"
                                          HeadersVisibility="Column">
                                    <DataGrid.ColumnHeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="Background" Value="#2A3A4A"/>
                                            <Setter Property="Foreground" Value="#E0E0E0"/>
                                            <Setter Property="Padding" Value="6,4"/>
                                            <Setter Property="BorderBrush" Value="#4A5A6A"/>
                                            <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                        </Style>
                                    </DataGrid.ColumnHeaderStyle>
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="30" IsReadOnly="True"/>
                                        <DataGridTemplateColumn Header="EN" Width="35">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding Enabled, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                              HorizontalAlignment="Center" VerticalAlignment="Center"
                                                              MinWidth="0" MinHeight="0" Padding="0" Margin="0"
                                                              LayoutTransform="{StaticResource DataGridCheckBoxScale}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTextColumn Header="CH" Binding="{Binding Channel}" Width="35"/>
                                        <DataGridTextColumn Header="Byte" Binding="{Binding StartByte}" Width="40"/>
                                        <DataGridTextColumn Header="Size" Binding="{Binding ByteCount}" Width="40"/>
                                        <DataGridTextColumn Header="Type" Binding="{Binding DataType}" Width="40"/>
                                        <DataGridTextColumn Header="End" Binding="{Binding Endian}" Width="35"/>
                                        <DataGridTextColumn Header="Var" Binding="{Binding TargetVarName}" Width="55"/>
                                        <DataGridTextColumn Header="Off" Binding="{Binding Offset}" Width="45"/>
                                        <DataGridTextColumn Header="Mul" Binding="{Binding Multiplier}" Width="50"/>
                                        <DataGridTextColumn Header="Div" Binding="{Binding Divisor}" Width="50"/>
                                        <DataGridTextColumn Header="Dec" Binding="{Binding Decimals}" Width="35"/>
                                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="70"/>
                                        <DataGridTextColumn Header="Unit" Binding="{Binding Unit}" Width="45"/>
                                        <DataGridTemplateColumn Header="WLo" Width="40">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding WarnLowEnabled, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                              HorizontalAlignment="Center" VerticalAlignment="Center"
                                                              MinWidth="0" MinHeight="0" Padding="0" Margin="0"
                                                              LayoutTransform="{StaticResource DataGridCheckBoxScale}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTextColumn Header="Lo" Binding="{Binding WarnLow}" Width="55"/>
                                        <DataGridTemplateColumn Header="WHi" Width="40">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding WarnHighEnabled, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                              HorizontalAlignment="Center" VerticalAlignment="Center"
                                                              MinWidth="0" MinHeight="0" Padding="0" Margin="0"
                                                              LayoutTransform="{StaticResource DataGridCheckBoxScale}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTextColumn Header="Hi" Binding="{Binding WarnHigh}" Width="55"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                                <TextBlock Text="Type: U=Unsigned, S=Signed | End: B=Big, L=Little" Opacity="0.5" Margin="0,8,0,0" FontSize="11"/>
                            </StackPanel>
                        </ui:CardExpander>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <ui:Button x:Name="CanReadButton" Content="Read" Margin="0,0,8,0" Icon="{ui:SymbolIcon ArrowDownload24}" Click="CanReadButton_Click"/>
                            <ui:Button x:Name="CanWriteButton" Content="Save" Appearance="Primary" Margin="0,0,8,0" Icon="{ui:SymbolIcon Save24}" Click="CanWriteButton_Click"/>
                            <ui:Button x:Name="CanDefaultButton" Content="Default" Icon="{ui:SymbolIcon ArrowReset24}" Click="CanDefaultButton_Click"/>
                        </StackPanel>

                        <TextBlock x:Name="CanStatusText" Text="" Margin="0,12,0,0" HorizontalAlignment="Center" Opacity="0.7"/>
                    </StackPanel>

                    <!-- Boot Screen Page -->
                    <StackPanel x:Name="StartupPage" Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                            <Border Width="4" Background="#0078D4" CornerRadius="2" Margin="0,0,12,0"/>
                            <TextBlock Text="Boot Screen" FontSize="28" FontWeight="SemiBold"/>
                        </StackPanel>
                        <views:StartupImageView x:Name="StartupImageViewControl"/>
                    </StackPanel>

                    <!-- Firmware Update Page -->
                    <StackPanel x:Name="FirmwarePage" Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                            <Border Width="4" Background="#0078D4" CornerRadius="2" Margin="0,0,12,0"/>
                            <TextBlock Text="Firmware Update" FontSize="28" FontWeight="SemiBold"/>
                        </StackPanel>

                        <ui:CardExpander Header="Current Version" IsExpanded="True" Margin="0,0,0,12">
                            <TextBlock Text="{Binding FirmwareVersion, StringFormat=Firmware: v{0}}"
                                       FontWeight="SemiBold" FontSize="16" Foreground="#4CAF50" Margin="8"/>
                        </ui:CardExpander>

                        <!-- Online Firmware Catalog -->
                        <ui:CardExpander x:Name="OnlineCatalogExpander" IsExpanded="True" Margin="0,0,0,12">
                            <ui:CardExpander.Header>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Grid.Row="0" Orientation="Horizontal">
                                        <ui:SymbolIcon Symbol="Cloud24" Margin="0,0,8,0" Foreground="#0891B2"/>
                                        <ui:TextBlock Text="Online Firmware Catalog" FontTypography="Body"/>
                                    </StackPanel>
                                    <ui:TextBlock Grid.Row="1" Text="Download firmware variants from GitHub Releases" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                </Grid>
                            </ui:CardExpander.Header>
                            <StackPanel Margin="8">
                                <!-- Release Selection -->
                                <Grid Margin="0,0,0,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ui:TextBlock Grid.Column="0" Text="Release:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <ComboBox Grid.Column="1" x:Name="ReleaseComboBox"
                                              ItemsSource="{Binding FirmwareCatalog.AvailableReleases}"
                                              SelectedItem="{Binding FirmwareCatalog.SelectedRelease, Mode=TwoWay}"
                                              SelectionChanged="ReleaseComboBox_SelectionChanged"
                                              IsEnabled="{Binding FirmwareCatalog.IsLoading, Converter={StaticResource InverseBoolConverter}}"
                                              Margin="0,0,8,0"/>
                                    <ui:Button Grid.Column="2" Content="Check for Updates"
                                               Icon="{ui:SymbolIcon ArrowSync24}"
                                               Command="{Binding FirmwareCatalog.LoadLatestReleaseCommand}"
                                               IsEnabled="{Binding FirmwareCatalog.IsLoading, Converter={StaticResource InverseBoolConverter}}"/>
                                </Grid>

                                <!-- Release Info -->
                                <Border Background="#1E293B" CornerRadius="8" Padding="12" Margin="0,0,0,12"
                                        Visibility="{Binding FirmwareCatalog.CurrentManifest, Converter={StaticResource NullToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <ui:SymbolIcon Symbol="Tag24" Margin="0,0,8,0" Foreground="#22C55E"/>
                                        <TextBlock>
                                            <Run Text="Version: " FontWeight="SemiBold"/>
                                            <Run Text="{Binding FirmwareCatalog.ReleaseVersion, Mode=OneWay}" Foreground="#22C55E"/>
                                            <Run Text="  |  Released: "/>
                                            <Run Text="{Binding FirmwareCatalog.ReleaseDate, Mode=OneWay}"/>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>

                                <!-- Firmware Variants List -->
                                <ItemsControl ItemsSource="{Binding FirmwareCatalog.Variants}" Margin="0,0,0,12">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#1A1A2E" CornerRadius="8" Padding="12" Margin="0,4"
                                                    BorderBrush="{Binding IsSelected, Converter={StaticResource BoolToBorderBrushConverter}}"
                                                    BorderThickness="2" Cursor="Hand"
                                                    MouseLeftButtonDown="FirmwareVariant_Click">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="332"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Thumbnail -->
                                                    <Border Grid.Column="0" Width="320" Height="192" CornerRadius="4" Background="#0D1B2A" Margin="0,0,12,0">
                                                        <Image Source="{Binding ThumbnailImage}" Stretch="Uniform"/>
                                                    </Border>

                                                    <!-- Info -->
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Name, Mode=OneWay}" FontWeight="SemiBold" FontSize="14"/>
                                                        <TextBlock Text="{Binding Description, Mode=OneWay}" Opacity="0.7" FontSize="12" TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock FontSize="11" Opacity="0.5" Margin="0,4,0,0">
                                                            <Run Text="{Binding Id, StringFormat=[{0}], Mode=OneWay}"/>
                                                            <Run Text="  |  "/>
                                                            <Run Text="{Binding SizeDisplay, Mode=OneWay}"/>
                                                        </TextBlock>
                                                    </StackPanel>

                                                    <!-- Select Indicator -->
                                                    <ui:SymbolIcon Grid.Column="2" Symbol="CheckmarkCircle24" FontSize="24" Foreground="#22C55E"
                                                                   Visibility="{Binding IsSelected, Converter={StaticResource BoolToVisibility}}"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Download Progress -->
                                <StackPanel Visibility="{Binding FirmwareCatalog.IsDownloading, Converter={StaticResource BoolToVisibility}}" Margin="0,0,0,12">
                                    <ProgressBar Value="{Binding FirmwareCatalog.Progress}" Height="8" Margin="0,0,0,4"/>
                                </StackPanel>

                                <!-- Status Message (always visible when not empty) -->
                                <TextBlock Text="{Binding FirmwareCatalog.StatusMessage}" FontSize="12" Foreground="#22C55E"
                                           Margin="0,0,0,12" TextAlignment="Center"
                                           Visibility="{Binding FirmwareCatalog.StatusMessage, Converter={StaticResource NullToVisibilityConverter}}"/>

                                <!-- Error Message -->
                                <Border Background="#7F1D1D" CornerRadius="4" Padding="8" Margin="0,0,0,12"
                                        Visibility="{Binding FirmwareCatalog.ErrorMessage, Converter={StaticResource NullToVisibilityConverter}}">
                                    <TextBlock Text="{Binding FirmwareCatalog.ErrorMessage}" Foreground="#FCA5A5"/>
                                </Border>

                                <!-- Actions -->
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <ui:Button Content="Download Selected"
                                               Icon="{ui:SymbolIcon ArrowDownload24}"
                                               Command="{Binding FirmwareCatalog.DownloadSelectedCommand}"
                                               IsEnabled="{Binding FirmwareCatalog.SelectedVariant, Converter={StaticResource NullToBoolConverter}}"
                                               Margin="0,0,8,0"/>
                                    <ui:Button Content="Download &amp; Flash"
                                               Appearance="Primary"
                                               Icon="{ui:SymbolIcon ArrowUpload24}"
                                               Command="{Binding FirmwareCatalog.DownloadAndFlashCommand}"
                                               IsEnabled="{Binding FirmwareCatalog.SelectedVariant, Converter={StaticResource NullToBoolConverter}}"/>
                                </StackPanel>
                            </StackPanel>
                        </ui:CardExpander>

                        <ui:CardExpander Header="Select Local File" IsExpanded="False" Margin="0,0,0,12">
                            <Grid Margin="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ui:TextBox Grid.Column="0" Text="{Binding FirmwareFilePath}" IsReadOnly="True" Margin="0,0,8,0"/>
                                <ui:Button Grid.Column="1" Content="Browse..." Icon="{ui:SymbolIcon FolderOpen24}" Command="{Binding BrowseFirmwareCommand}"/>
                            </Grid>
                        </ui:CardExpander>

                        <ui:CardExpander Header="Transfer Progress" IsExpanded="True" Margin="0,0,0,12">
                            <StackPanel Margin="8">
                                <ProgressBar Value="{Binding FirmwareProgress}" Height="24" Margin="0,0,0,8"/>
                                <TextBlock Text="{Binding FirmwareProgressText}"/>
                            </StackPanel>
                        </ui:CardExpander>

                        <ui:CardExpander Header="Communication Log" IsExpanded="False" Margin="0,0,0,12">
                            <StackPanel Margin="8">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                    <ui:Button Content="Clear" Margin="0,0,8,0" Icon="{ui:SymbolIcon Delete24}" Command="{Binding ClearFirmwareLogCommand}"/>
                                    <ui:Button Content="Copy" Icon="{ui:SymbolIcon Copy24}" Command="{Binding CopyFirmwareLogCommand}"/>
                                </StackPanel>
                                <TextBox x:Name="FirmwareLogTextBox"
                                         Text="{Binding FirmwareLog}"
                                         IsReadOnly="True"
                                         Height="180"
                                         VerticalScrollBarVisibility="Auto"
                                         HorizontalScrollBarVisibility="Auto"
                                         FontFamily="Cascadia Code, Consolas"
                                         Background="#0C0C0C"
                                         Foreground="#4EC9B0"
                                         TextChanged="FirmwareLogTextBox_TextChanged"/>
                            </StackPanel>
                        </ui:CardExpander>

                        <ui:Button Content="Start Firmware Update"
                                   HorizontalAlignment="Center"
                                   Appearance="Primary"
                                   Icon="{ui:SymbolIcon ArrowUpload24}"
                                   Command="{Binding StartFirmwareUpdateCommand}"
                                   IsEnabled="{Binding CanStartFirmwareUpdate}"/>
                    </StackPanel>

                    <!-- About Page -->
                    <StackPanel x:Name="AboutPage" Visibility="Collapsed" HorizontalAlignment="Center" VerticalAlignment="Center" MaxWidth="600">
                        <!-- Logo -->
                        <Image Source="Assets/FM1.png" Width="280" Margin="0,0,0,32"/>

                        <!-- Title -->
                        <TextBlock Text="FULLMONI-WIDE Terminal" FontSize="32" FontWeight="Bold" HorizontalAlignment="Center"/>
                        <TextBlock Text="Version 1.0.0" FontSize="14" Opacity="0.7" HorizontalAlignment="Center" Margin="0,8,0,0"/>

                        <!-- Description -->
                        <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="8" Padding="20" Margin="0,32,0,0">
                            <StackPanel>
                                <TextBlock Text="About This Tool" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                                <TextBlock TextWrapping="Wrap" FontSize="13" LineHeight="22" Opacity="0.85">
                                    Configuration tool for FULLMONI-WIDE digital meter.
                                    Connect via USB to configure parameters and update firmware.
                                </TextBlock>

                                <TextBlock Text="Features" FontSize="14" FontWeight="SemiBold" Margin="0,20,0,8"/>
                                <StackPanel Margin="8,0,0,0">
                                    <TextBlock Text="• Real-time status monitoring (RPM, Speed, Temp, etc.)" FontSize="12" Opacity="0.8" Margin="0,2"/>
                                    <TextBlock Text="• Parameter settings (Tire size, Gear ratio, Warnings)" FontSize="12" Opacity="0.8" Margin="0,2"/>
                                    <TextBlock Text="• CAN configuration (ECU presets, Custom IDs)" FontSize="12" Opacity="0.8" Margin="0,2"/>
                                    <TextBlock Text="• Boot screen customization (765×256 BMP)" FontSize="12" Opacity="0.8" Margin="0,2"/>
                                    <TextBlock Text="• Firmware update via USB (~268KB/s)" FontSize="12" Opacity="0.8" Margin="0,2"/>
                                </StackPanel>

                                <TextBlock Text="Hardware" FontSize="14" FontWeight="SemiBold" Margin="0,20,0,8"/>
                                <TextBlock Text="Renesas RX72N MCU • 800×256 TFT LCD • CAN Bus • Neopixel LEDs"
                                           FontSize="12" Opacity="0.8" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- Copyright & Links -->
                        <TextBlock Text="© 2024-2026 FULLMONI-WIDE Project" FontSize="12" Opacity="0.5"
                                   HorizontalAlignment="Center" Margin="0,24,0,0"/>
                        <TextBlock Text="Open Source Hardware &amp; Software (MIT License)" FontSize="11" Opacity="0.4"
                                   HorizontalAlignment="Center" Margin="0,4,0,0"/>

                        <ui:HyperlinkButton Content="🔗 GitHub" NavigateUri="https://github.com/tomoya723/FULLMONI-WIDE"
                                            HorizontalAlignment="Center" Margin="0,16,0,0"/>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
            </Border>
        </Grid>

        <!-- ステータスバー -->
        <Border Grid.Row="2" Padding="16,10">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                    <GradientStop Color="#1A1A2E" Offset="0"/>
                    <GradientStop Color="#0D1B2A" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>
            <Grid>
                <TextBlock Text="{Binding ActivityStatus}" Opacity="0.7" VerticalAlignment="Center"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Ellipse Width="8" Height="8" Margin="0,0,8,0">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="#555"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsParametersLoaded}" Value="True">
                                        <Setter Property="Fill" Value="#4CAF50"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Text="Parameters Loaded" Opacity="0.7"
                               Visibility="{Binding IsParametersLoaded, Converter={StaticResource BoolToVisibility}}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</ui:FluentWindow>
