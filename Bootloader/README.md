# RX72N ブートローダー

2線式UART（TX/RX）経由でファームウェア更新を行うブートローダーです。
**XON/XOFF ソフトウェアフロー制御対応** により、高速かつ確実な転送を実現します。

> ⚠️ **警告**: Smart Configuratorでコード生成を実行しないでください。
> `r_Config_SCI9_receive_interrupt()` のカスタム実装が上書きされ、通信不能になります。
> scfgファイルは意図的に削除されています。

## 特徴

- **MCU**: RX72N (4MB Flash LINEAR MODE)
- **UART**: SCI9 @ 115200bps（2線式）
- **フロー制御**: XON/XOFF（ソフトウェアフロー制御）
- **メモリマップ**:
  - ブートローダー: 0xFFC00000 - 0xFFC1FFFF (128KB)
  - アプリケーション: 0xFFC20000 - 0xFFFFFFFF (3.875MB)
- **Flash書き込み**: RAM2から実行（RX72N 4MB Linear Mode対応）

## 動作フロー

```
リセット
   ↓
ブートローダー起動
   ↓
強制アップデートフラグ確認（RAM2: 0x0087FFF0）
   ↓
┌─────────────────┬─────────────────┐
│ フラグあり      │ フラグなし      │
│ (0xDEADBEEF)    │                 │
│      ↓          │      ↓          │
│ フラグクリア    │ FWヘッダ検証    │
│      ↓          │ (0xFFC20000)    │
│ アップデート    │      ↓          │
│ モード          │ ┌────┴────┐     │
│      ↓          │ │Magic  Magic│  │
│ Flash消去       │ │一致   不一致│ │
│      ↓          │ │↓       ↓   │  │
│ ファイル転送    │ │アプリ  ↓   │  │
│ 待ち            │ │起動   アップ│ │
│      ↓          │ │      デート│  │
│ ベリファイ      │ │      モード│  │
│      ↓          │ └─────────┘    │
│ ソフトリセット  │                 │
└─────────────────┴─────────────────┘
```

### アプリケーション有効性判定

| 条件 | Magic値 @ 0xFFC20000 | 判定 | 動作 |
|------|----------------------|------|------|
| 正常なアプリ | `0x52584657` ("RXFW") | 有効 | アプリ起動 |
| Flash消去済み | `0xFFFFFFFF` | 無効 | アップデートモード |
| 書き込み途中 | 不定値 | 無効 | アップデートモード |

## ファームウェア転送手順

### 1. BINファイル生成

Firmwareプロジェクトのビルド後、`Firmware.bin`が自動生成されます。

```
Firmware/HardwareDebug/Firmware.bin
```

### 2. Tera Term設定

**シリアルポート設定：**
- ポート: COM3（環境による）
- スピード: 115200
- データ: 8 bit
- パリティ: none
- ストップビット: 1 bit
- フロー制御: **Xon/Xoff** ← 重要！

**ファイル送信設定（推奨）：**
| 項目 | 値 | 説明 |
|------|-----|------|
| Delay type | **no delay** | XON/XOFFで制御するため不要 |
| バイナリ | **✓チェック** | バイナリモード必須 |

> **Note**: XON/XOFFフロー制御を有効にすることで、ブートローダーがバッファ満杯時に自動的にXOFF(0x13)を送信して転送を一時停止し、バッファが空いたらXON(0x11)で再開します。これにより遅延設定なしで高速転送が可能になります。

### 3. 転送手順

#### 方法A: Firmwareの`fwupdate`コマンドを使用（推奨）

1. ターミナルを接続
2. 任意のキーを押してパラメータモードに入る
3. `fwupdate` コマンドを入力
4. `yes` を入力して確認
5. 自動的にBootloaderが起動し、`Waiting for data...` 表示
6. **ファイル** → **ファイル送信** → `Firmware.bin` を選択
7. 転送完了まで待機
8. `*** UPDATE SUCCESS ***` 表示後、自動リセット → アプリ起動

#### 方法B: Flash消去済み状態から

1. ターミナルを接続
2. ボードをリセット（または電源投入）
3. アプリが無効の場合、自動的にアップデートモードへ
4. `Waiting for data...` 表示を確認
5. **ファイル** → **ファイル送信** → `Firmware.bin` を選択
6. 転送完了まで待機
7. `*** UPDATE SUCCESS ***` 表示後、自動リセット → アプリ起動

### 転送時間の目安

| フロー制御 | 設定 | 転送時間（1.2MB） |
|-----------|------------|-------------------|
| XON/XOFF | no delay | **約2分** ✓推奨 |
| なし | 128B/50ms | 約10分（フォールバック）|

> **XON/XOFFが使えない場合**: フロー制御を`none`にして、Send size=128 bytes、Delay time=50 msに設定してください。

## トラブルシューティング

### 転送が途中で止まる / アプリが起動しない

- **原因**: データ欠落（約21KB不足するパターンが多い）
- **対策**: Send sizeを128に、Delay timeを50msに設定

### アップデートモードに入らない

- Firmwareの `fwupdate` コマンドを使用しているか確認
- アプリが壊れている場合は電源再投入で自動的にアップデートモードへ

### ベリファイNG

- BINファイルが正しく生成されているか確認
- Firmwareプロジェクトを再ビルド

## 技術詳細

### XON/XOFF フロー制御

2線式UART（RTS/CTS線なし）でも使えるソフトウェアフロー制御を実装しています。

| 制御文字 | コード | 動作 |
|---------|--------|------|
| XOFF | 0x13 (Ctrl+S) | 送信停止要求 |
| XON | 0x11 (Ctrl+Q) | 送信再開要求 |

**閾値設定:**
- XOFF送信: バッファ75%以上（192KB）
- XON送信: バッファ25%以下（64KB）

転送中のターミナル表示:
- `-` : XOFF送信（一時停止）
- `+` : XON送信（再開）

### RX72N 4MB Linear Mode対応

RX72Nの4MB Flashは単一バンク構成のため、Flashに書き込み中は同じFlashからの実行ができません。
この制限を回避するため、Flash書き込み関数（`flash_write_impl`）をRAM2（0x00800000）にコピーして実行しています。

### リングバッファ

256KBのリングバッファを使用してFlash書き込み中のデータを保持します。
XON/XOFFフロー制御と組み合わせることで、オーバーフローを防止します。

## ファイル構成

```
Bootloader/
├── src/
│   ├── main.c           # エントリポイント (main関数)
│   ├── boot_loader.c    # ブートローダー本体
│   ├── boot_loader.h    # ヘッダ
│   └── linker_script.ld # リンカスクリプト
├── HardwareDebug/
│   ├── Bootloader.elf   # デバッグ用ELF
│   └── Bootloader.mot   # 書き込み用MOT
└── README.md            # このファイル
```

## リファレンスからの変更点

本ブートローダーは **Renesas r_fwup リファレンスコード** をベースに、以下の変更を加えています。

### ベースとしたリファレンス

| 項目 | 内容 |
|------|------|
| 名称 | RX Family Firmware Update Module (r_fwup) |
| バージョン | v2.02 |
| 公式サイト | https://www.renesas.com/rx-fwup |
| ドキュメント | R01AN6849EJ (Application Note) |

### 1. RX72N 4MB Linear Mode対応

**問題**: RX72Nの4MB Flashは単一バンク構成（Linear Mode）のため、Code Flashへの書き込み中は同じFlashからのプログラム実行ができない。

**解決策**: Flash書き込み関数（`flash_write_impl`）を実行時にRAM2（0x00800000）にコピーし、RAMから実行するように変更。

```c
/* flash_write_impl関数をRAM2にコピーして実行 */
memcpy((void*)0x00800000, flash_write_impl, FLASH_WRITE_IMPL_SIZE);
s_ram_flash_write = (flash_write_func_t)0x00800000;
```

### 2. XON/XOFFソフトウェアフロー制御

**問題**: 2線式UART（TX/RXのみ、RTS/CTSなし）ではハードウェアフロー制御が使えず、Flash書き込み中にデータロスが発生。

**解決策**: XON/XOFFソフトウェアフロー制御を実装。
- Flash書き込み前にXOFF（0x13）を送信してPC側の送信を一時停止
- 2ms待機後にFlash書き込み実行
- 書き込み完了後にXON（0x11）を送信して再開

### 3. 256KBリングバッファ

**問題**: 割り込み無効中に受信データを保持する必要がある。

**解決策**: BSS領域に256KBのリングバッファを確保。

### 4. 強制アップデートモード

**変更前（リファレンス）**: ユーザースイッチで強制アップデートモードに入る

**変更後**: RAM2経由のフラグ通信方式
- Firmwareの `fwupdate` コマンドでRAM2 (0x0087FFF0) にマジックナンバー (0xDEADBEEF) をセット
- ソフトウェアリセット後、Bootloaderがフラグを検出してアップデートモードへ
- フラグは検出後即座にクリア（電源断で揮発）

### 5. ファームウェアヘッダ検証

**追加機能**: アプリケーション有効性をファームウェアヘッダで判定
- ヘッダ位置: 0xFFC20000（アプリ領域先頭）
- Magic番号: 0x52584657 ("RXFW")
- エントリポイント: ヘッダ内のentry_pointフィールドを参照

### 6. 転送プロトコルの簡素化

**変更前（リファレンス）**: コマンドベースのプロトコル（同期、消去コマンド、書き込みコマンド等）

**変更後**: シンプルなバイナリ転送
- Tera Termのファイル送信機能で直接BINファイルを転送
- 20秒間データなしでタイムアウト → 転送完了と判断
- 特別なツール不要

### 変更したファイル

| ファイル | 変更内容 |
|---------|---------|
| boot_loader.c | RAM実行、XON/XOFF、リングバッファ、'U'キー検出 |
| boot_loader.h | メモリマップ、閾値定義 |
| linker_script.ld | RAM2領域の定義 |

## ライセンス

BSD-3-Clause (Renesas Electronics Corporation)
