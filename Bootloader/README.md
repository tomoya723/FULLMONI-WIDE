# RX72N ブートローダー

2線式UART（TX/RX、フロー制御なし）経由でファームウェア更新を行うブートローダーです。

## 特徴

- **MCU**: RX72N (4MB Flash LINEAR MODE)
- **UART**: SCI9 @ 115200bps（2線式、フロー制御なし）
- **メモリマップ**:
  - ブートローダー: 0xFFC00000 - 0xFFC1FFFF (128KB)
  - アプリケーション: 0xFFC20000 - 0xFFFFFFFF (3.875MB)
- **Flash書き込み**: RAM2から実行（RX72N 4MB Linear Mode対応）

## 動作フロー

```
リセット
   ↓
ブートローダー起動
   ↓
'U'キー待機（2秒間）
   ↓
┌─────────────────┬─────────────────┐
│ 'U'キー押下     │ タイムアウト    │
│      ↓          │      ↓          │
│ アップデート    │ アプリ検証      │
│ モード          │      ↓          │
│      ↓          │ ┌────┴────┐     │
│ Flash消去       │ │OK     NG│     │
│      ↓          │ │↓       ↓│     │
│ ファイル転送    │ │アプリ  ↓│     │
│      ↓          │ │起動   待機     │
│ ベリファイ      │ └─────────┘     │
│      ↓          │                 │
│ ソフトリセット  │                 │
└─────────────────┴─────────────────┘
```

## ファームウェア転送手順

### 1. BINファイル生成

Firmwareプロジェクトのビルド後、`Firmware.bin`が自動生成されます。

```
Firmware/HardwareDebug/Firmware.bin
```

### 2. Tera Term設定

**シリアルポート設定：**
- ポート: COM3（環境による）
- スピード: 115200
- データ: 8 bit
- パリティ: none
- ストップビット: 1 bit
- フロー制御: **none**

**ファイル送信設定（重要）：**
| 項目 | 値 | 説明 |
|------|-----|------|
| Delay type | 変更（no delay以外） | 遅延を有効化 |
| Send size | **128** bytes | Flash書き込み単位と一致 |
| Delay time | **50** ms | Flash書き込み完了待ち |
| バイナリ | **✓チェック** | バイナリモード必須 |

### 3. 転送手順

1. ターミナルを接続して準備
2. ボードをリセット
3. `Press 'U' within 2 sec for UPDATE MODE...` 表示中に **'U'キー** を押す
4. `Waiting for data...` 表示を確認
5. **ファイル** → **ファイル送信** → `Firmware.bin` を選択
6. 上記の送信設定を確認して **OK**
7. 転送完了まで待機（約8分）
8. `*** UPDATE SUCCESS ***` 表示を確認
9. 自動的にソフトリセット → アプリ起動

### 転送時間の目安

| Send size | Delay time | 転送時間（1.2MB） |
|-----------|------------|-------------------|
| 128 bytes | 50 ms | 約8分 ✓推奨 |
| 4096 bytes | 200 ms | 約2分（不安定） |

**注意**: 転送時間を短縮するとデータ欠落が発生し、アプリが起動しません。
確実な転送には `128 bytes / 50 ms` 設定を使用してください。

## トラブルシューティング

### 転送が途中で止まる / アプリが起動しない

- **原因**: データ欠落（約21KB不足するパターンが多い）
- **対策**: Send sizeを128に、Delay timeを50msに設定

### 'U'キーが認識されない

- ターミナル接続後、リセット直後に'U'を押す
- 大文字'U'でも小文字'u'でも可

### ベリファイNG

- BINファイルが正しく生成されているか確認
- Firmwareプロジェクトを再ビルド

## 技術詳細

### RX72N 4MB Linear Mode対応

RX72Nの4MB Flashは単一バンク構成のため、Flashに書き込み中は同じFlashからの実行ができません。
この制限を回避するため、Flash書き込み関数（`flash_write_impl`）をRAM2（0x00800000）にコピーして実行しています。

### リングバッファ

2線式UARTでフロー制御がないため、256KBのリングバッファを使用してFlash書き込み中のデータを保持します。

## ファイル構成

```
Bootloader/
├── src/
│   ├── boot_loader.c    # メインロジック
│   ├── boot_loader.h    # ヘッダ
│   ├── Bootloader.c     # エントリポイント
│   └── linker_script.ld # リンカスクリプト
├── HardwareDebug/
│   ├── Bootloader.elf   # デバッグ用ELF
│   └── Bootloader.mot   # 書き込み用MOT
└── README.md            # このファイル
```

## ライセンス

BSD-3-Clause (Renesas Electronics Corporation)
