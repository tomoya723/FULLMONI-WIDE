# RX72N ブートローダー

2線式UART（TX/RX）経由でファームウェア更新を行うブートローダーです。
**XON/XOFF ソフトウェアフロー制御対応** により、高速かつ確実な転送を実現します。

## 特徴

- **MCU**: RX72N (4MB Flash LINEAR MODE)
- **UART**: SCI9 @ 115200bps（2線式）
- **フロー制御**: XON/XOFF（ソフトウェアフロー制御）
- **メモリマップ**:
  - ブートローダー: 0xFFC00000 - 0xFFC1FFFF (128KB)
  - アプリケーション: 0xFFC20000 - 0xFFFFFFFF (3.875MB)
- **Flash書き込み**: RAM2から実行（RX72N 4MB Linear Mode対応）

## 動作フロー

```
リセット
   ↓
ブートローダー起動
   ↓
'U'キー待機（2秒間）
   ↓
┌─────────────────┬─────────────────┐
│ 'U'キー押下     │ タイムアウト    │
│      ↓          │      ↓          │
│ アップデート    │ アプリ検証      │
│ モード          │      ↓          │
│      ↓          │ ┌────┴────┐     │
│ Flash消去       │ │OK     NG│     │
│      ↓          │ │↓       ↓│     │
│ ファイル転送    │ │アプリ  ↓│     │
│      ↓          │ │起動   待機     │
│ ベリファイ      │ └─────────┘     │
│      ↓          │                 │
│ ソフトリセット  │                 │
└─────────────────┴─────────────────┘
```

## ファームウェア転送手順

### 1. BINファイル生成

Firmwareプロジェクトのビルド後、`Firmware.bin`が自動生成されます。

```
Firmware/HardwareDebug/Firmware.bin
```

### 2. Tera Term設定

**シリアルポート設定：**
- ポート: COM3（環境による）
- スピード: 115200
- データ: 8 bit
- パリティ: none
- ストップビット: 1 bit
- フロー制御: **Xon/Xoff** ← 重要！

**ファイル送信設定（推奨）：**
| 項目 | 値 | 説明 |
|------|-----|------|
| Delay type | **no delay** | XON/XOFFで制御するため不要 |
| バイナリ | **✓チェック** | バイナリモード必須 |

> **Note**: XON/XOFFフロー制御を有効にすることで、ブートローダーがバッファ満杯時に自動的にXOFF(0x13)を送信して転送を一時停止し、バッファが空いたらXON(0x11)で再開します。これにより遅延設定なしで高速転送が可能になります。

### 3. 転送手順

1. ターミナルを接続して準備
2. ボードをリセット
3. `Press 'U' within 2 sec for UPDATE MODE...` 表示中に **'U'キー** を押す
4. `Waiting for data...` 表示を確認
5. **ファイル** → **ファイル送信** → `Firmware.bin` を選択
6. 上記の送信設定を確認して **OK**
7. 転送完了まで待機（約8分）
8. `*** UPDATE SUCCESS ***` 表示を確認
9. 自動的にソフトリセット → アプリ起動

### 転送時間の目安

| フロー制御 | 設定 | 転送時間（1.2MB） |
|-----------|------------|-------------------|
| XON/XOFF | no delay | **約2分** ✓推奨 |
| なし | 128B/50ms | 約10分（フォールバック）|

> **XON/XOFFが使えない場合**: フロー制御を`none`にして、Send size=128 bytes、Delay time=50 msに設定してください。

## トラブルシューティング

### 転送が途中で止まる / アプリが起動しない

- **原因**: データ欠落（約21KB不足するパターンが多い）
- **対策**: Send sizeを128に、Delay timeを50msに設定

### 'U'キーが認識されない

- ターミナル接続後、リセット直後に'U'を押す
- 大文字'U'でも小文字'u'でも可

### ベリファイNG

- BINファイルが正しく生成されているか確認
- Firmwareプロジェクトを再ビルド

## 技術詳細

### XON/XOFF フロー制御

2線式UART（RTS/CTS線なし）でも使えるソフトウェアフロー制御を実装しています。

| 制御文字 | コード | 動作 |
|---------|--------|------|
| XOFF | 0x13 (Ctrl+S) | 送信停止要求 |
| XON | 0x11 (Ctrl+Q) | 送信再開要求 |

**閾値設定:**
- XOFF送信: バッファ75%以上（192KB）
- XON送信: バッファ25%以下（64KB）

転送中のターミナル表示:
- `-` : XOFF送信（一時停止）
- `+` : XON送信（再開）

### RX72N 4MB Linear Mode対応

RX72Nの4MB Flashは単一バンク構成のため、Flashに書き込み中は同じFlashからの実行ができません。
この制限を回避するため、Flash書き込み関数（`flash_write_impl`）をRAM2（0x00800000）にコピーして実行しています。

### リングバッファ

256KBのリングバッファを使用してFlash書き込み中のデータを保持します。
XON/XOFFフロー制御と組み合わせることで、オーバーフローを防止します。

## ファイル構成

```
Bootloader/
├── src/
│   ├── main.c           # エントリポイント (main関数)
│   ├── boot_loader.c    # ブートローダー本体
│   ├── boot_loader.h    # ヘッダ
│   └── linker_script.ld # リンカスクリプト
├── HardwareDebug/
│   ├── Bootloader.elf   # デバッグ用ELF
│   └── Bootloader.mot   # 書き込み用MOT
└── README.md            # このファイル
```

## ライセンス

BSD-3-Clause (Renesas Electronics Corporation)
